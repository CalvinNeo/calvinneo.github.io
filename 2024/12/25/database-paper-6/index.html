<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>





<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="数据库,论文阅读," />





  <link rel="alternate" href="/atom.xml" title="Calvin's Marbles" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="本部分开始为最新的学习笔记。包含 PolarDB Serverless、Monkey: Optimal Navigable Key-Value Store、Are You Sure You Want to Use MMAP in Your Database Management System、SLM-DB: Single-Level Key-Value Store with Persistent">
<meta name="keywords" content="数据库,论文阅读">
<meta property="og:type" content="article">
<meta property="og:title" content="Database paper part 6">
<meta property="og:url" content="http://www.calvinneo.com/2024/12/25/database-paper-6/index.html">
<meta property="og:site_name" content="Calvin&#39;s Marbles">
<meta property="og:description" content="本部分开始为最新的学习笔记。包含 PolarDB Serverless、Monkey: Optimal Navigable Key-Value Store、Are You Sure You Want to Use MMAP in Your Database Management System、SLM-DB: Single-Level Key-Value Store with Persistent">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/polardb-serverless/f1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/polardb-serverless/f2.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/polardb-serverless/f3.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/polardb-serverless/7.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/f2.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/e1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/f3.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/e2.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/f4-1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/f4-2.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/f4.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/f5.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/e3.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/monkey/e4.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/mmap/1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre2.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre3.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre4.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre5.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre6.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre7.png">
<meta property="og:image" content="http://www.calvinneo.com/img/dbpaper/slm-db/pre8.png">
<meta property="og:updated_time" content="2025-04-20T13:27:41.828Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Database paper part 6">
<meta name="twitter:description" content="本部分开始为最新的学习笔记。包含 PolarDB Serverless、Monkey: Optimal Navigable Key-Value Store、Are You Sure You Want to Use MMAP in Your Database Management System、SLM-DB: Single-Level Key-Value Store with Persistent">
<meta name="twitter:image" content="http://www.calvinneo.com/img/dbpaper/polardb-serverless/f1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.calvinneo.com/2024/12/25/database-paper-6/"/>





  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5487541356791902"
     crossorigin="anonymous"></script>
  <title>Database paper part 6 | Calvin's Marbles</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Calvin's Marbles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.calvinneo.com/2024/12/25/database-paper-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Calvin Neo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Calvin's Marbles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Database paper part 6
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-12-25T21:33:22+08:00">
                2024-12-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本部分开始为最新的学习笔记。包含 PolarDB Serverless、Monkey: Optimal Navigable Key-Value Store、Are You Sure You Want to Use MMAP in Your Database Management System、SLM-DB: Single-Level Key-Value Store with Persistent Memory</p>
<a id="more"></a>

<h1 id="PolarDB-Serverless-A-Cloud-Native-Database-for-Disaggregated-Data-Centers"><a href="#PolarDB-Serverless-A-Cloud-Native-Database-for-Disaggregated-Data-Centers" class="headerlink" title="PolarDB Serverless: A Cloud Native Database for Disaggregated Data Centers"></a>PolarDB Serverless: A Cloud Native Database for Disaggregated Data Centers</h1><p><a href="https://users.cs.utah.edu/~lifeifei/papers/polardbserverless-sigmod21.pdf" target="_blank" rel="noopener">https://users.cs.utah.edu/~lifeifei/papers/polardbserverless-sigmod21.pdf</a></p>
<h2 id="INTRODUCTION"><a href="#INTRODUCTION" class="headerlink" title="INTRODUCTION"></a>INTRODUCTION</h2><p>大概有三种 cloud 数据库的架构：</p>
<ol>
<li>monolithic</li>
<li>virtual machine with remote disk</li>
<li>shared storage</li>
</ol>
<p>后两种也被统称为存算分离的架构。</p>
<p>存算一体的架构缺点：</p>
<ul>
<li>将 db 分配到对应的机器类似于解决 bin-packing 问题</li>
<li>难以满足客户的灵活的资源需要</li>
<li>资源之间没法独立地进行恢复</li>
</ul>
<p>下面两种存算分离的架构：CPU 和内存同样存在 bin-packing 的问题，内存开销大。</p>
<p><img src="/img/dbpaper/polardb-serverless/f1.png"></p>
<p>因此 PolarDB Serverless 共享了内存。</p>
<p>和 Aurora、HyperScale 以及 PolarDB 一样，它有一个 RW 的主节点，以及多个 read only replica。它也可以通过提出的 disaggregation 架构支持多个 RW 主节点，但不在这个论文中讨论。</p>
<p>一些挑战：</p>
<ul>
<li>引入共享内存后，事务的正确性。<ul>
<li>read after write 不会在节点间丢失修改 -&gt; cache invalidation</li>
<li>RW 节点在 split 或者 merge 一个 B+Tree 的时候，其他的 RO 节点不能看到一个不一致的 B 树 -&gt; global page latch</li>
<li>不能脏读 -&gt; 在不同的 database node 间同步 read view</li>
</ul>
</li>
</ul>
<ul>
<li>网络延迟<ul>
<li>使用 RDMA CAS 技术提优化 global latch 的获取</li>
<li>page materialization offloading 技术将 dirty page 从 remote memory 中驱逐，而不是将它们 flush 到存储中</li>
</ul>
</li>
</ul>
<h2 id="BACKGROUND"><a href="#BACKGROUND" class="headerlink" title="BACKGROUND"></a>BACKGROUND</h2><h3 id="PolarDB"><a href="#PolarDB" class="headerlink" title="PolarDB"></a>PolarDB</h3><p>介绍了 PolarFS。</p>
<p>RW 和 RO 节点通过 redo log 同步内存状态。通过 LSN 实现一致性，其执行流程是：</p>
<ol>
<li>将所有的 redo log flush 到 PolarFS 中</li>
<li>提交事务</li>
<li>RW 异步广播消息：read log 以及最新的 LSN 即 LSN_rw。</li>
<li>当 ROi 收到 RW 的消息后，从 PolarFS 上拉取所有的 redo log，将它们 apply 到 buffer pool 中的 buffered page 里面</li>
<li>ROi 此时就和 RW 完成了已同步</li>
<li>ROi 将自己的 LSN_ro 发送给 RW</li>
<li>RW 可以在后台将 read log 去 truncate 到所有的 LSN_roi 的最小值</li>
<li>ROi可以处理 LSN_roi 之前的读取，提供 SI 隔离级别</li>
</ol>
<p>假设某个 ROk 落后了，比方说落后超过 1M，这样的节点会被发现，并且被踢出集群。</p>
<p><img src="/img/dbpaper/polardb-serverless/f2.png"></p>
<h3 id="Disaggregated-Data-Centers"><a href="#Disaggregated-Data-Centers" class="headerlink" title="Disaggregated Data Centers"></a>Disaggregated Data Centers</h3><p><img src="/img/dbpaper/polardb-serverless/f3.png"></p>
<p>在 disaggregation 架构下，一个数据库实例所需要的计算、内存和存储资源将被分配到同一个 PoD 下面。不同的 db instance 则看见恶意分配到不同的 PoD 下面。计算和内存资源会被尽可能分配到同一个 ToR 下面。</p>
<p>一台机器有两个 RDMA NIC，他们会被连接到两个 ToR 交换机上面，从而避免网络连接失效。一个 leaf switch group 由多个 leaf switch 组成。ToR switch 连接到 leaf switch 上。</p>
<h3 id="Serverless-Databases"><a href="#Serverless-Databases" class="headerlink" title="Serverless Databases"></a>Serverless Databases</h3><p>pay-as-you-go model。</p>
<p>一个 ACU 包含了 2GiB 的内存以及对应的虚拟处理器。这个设定 fixes the resource ratio。比如，分析数据库可能需要更多的内存，而不是 CPU，因为它们可能要 cache 大量的数据。对应的，事务数据库需要大量的 CPU 去处理业务的尖峰。而一个小内存，只要能满足 cache hit，那也是足够的了。</p>
<h2 id="DESIGN"><a href="#DESIGN" class="headerlink" title="DESIGN"></a>DESIGN</h2><h3 id="Disaggregated-Memory"><a href="#Disaggregated-Memory" class="headerlink" title="Disaggregated Memory"></a>Disaggregated Memory</h3><h4 id="Remote-Memory-Access-Interface"><a href="#Remote-Memory-Access-Interface" class="headerlink" title="Remote Memory Access Interface"></a>Remote Memory Access Interface</h4><p>这里内存也是按照 Page 来组织的。一个 PageID 可以表示为 <code>(space, page_no)</code>。使用 page_register 和 page_unregister 去做类似 RC 一样的内存管理。page_read 从 remote memory pool 拉数据到 local cache。page_write 将 page 从 local cache 写到 remote memory pool。page_invalidate 被 RW 调用，用来将所有 RO 的 local cache 上的 page 设置为无效。</p>
<h4 id="Remote-Memory-Management"><a href="#Remote-Memory-Management" class="headerlink" title="Remote Memory Management"></a>Remote Memory Management</h4><p>内存分配的单位是 slab，一个 slab 是 1Gb。</p>
<h5 id="Page-Array-PA"><a href="#Page-Array-PA" class="headerlink" title="Page Array(PA)"></a>Page Array(PA)</h5><p>一个 slab 被一个 PA 结构实现。一个 PA 是一个连续的内存，包含 16KB page 的 array。PA 中的 page 可以被 remote node 通过 RDMA 直接访问，因为他们在启动的时候就已经被注册到 RDMA NIC 上了。</p>
<p>一个 memory node 也被称为一个 slab node。一个 slab node 管理多个 slab。一个实例可以对应到多个 slab node 上，其中第一个 slab node 称为 home node。home node 中有一些 instance 级别的元数据。</p>
<h5 id="Page-Address-Table-PAT"><a href="#Page-Address-Table-PAT" class="headerlink" title="Page Address Table (PAT)"></a>Page Address Table (PAT)</h5><p>PAT is a hash table that records the location (slab node id and physical memory address) and reference count of each page. 也就是前面 page_register 和 page_unregister 所操作的东西。</p>
<p>【Q】这个结构保存在哪里？</p>
<h5 id="Page-Invalidation-Bitmap-PIB"><a href="#Page-Invalidation-Bitmap-PIB" class="headerlink" title="Page Invalidation Bitmap (PIB)"></a>Page Invalidation Bitmap (PIB)</h5><p>PIB is a bitmap. For each entry in the PAT table, there is an invalidation bit in PIB. Value 0 indicates that the copy of the page in the memory pool is of the latest version, while value 1 means that the RW node has updated the page in its local cache and haven’t written it back to the remote memory pool yet. There is also a local PIB on each RO node, indicating whether each page in the RO node’s local cache is outdated.</p>
<h3 id="Page-Materialization-Offloading"><a href="#Page-Materialization-Offloading" class="headerlink" title="Page Materialization Offloading"></a>Page Materialization Offloading</h3><p>Aurora 提出 log is database 的理论。将 redo log 看做是增量的 page 修改。Socrates 进一步地，将 log 从 storage 分离。Log 被存在 XLOG 服务中，然后被异步地发送到一系列 page server 中，每一个 page server 负责一个 database partition，独立地重放日志，生成 page 并处理 GetPage@LSN 请求。</p>
<p>PolarDB 类似于 Socrates，将 PolarFS 设计为分别存放 log 和 page 到两个 chunck 中。redo log 首先被持久化到 log chunkc 中，然后被异步地发送到 page chunck 中。在 page chunck 中，logs 被 apply，从而更新 page。不同于 Socrates，为了重用 PolarFS，log 只会被发送到 page chunk 的 leader 节点，这个节点会物化 page，然后将 update 通过 ParallelRaft 通知给其他的 replica。This method adds additional latency to the ApplyLog operation due to the replication cost. However, it is not a critical issue because ApplyLog is an asynchronous operation not in the critical path. Moreover, since the replicated state machine guarantees data consistency between page chunks, there is no need for an extra gossip protocol among storage nodes like in Aurora.</p>
<p><img src="/img/dbpaper/polardb-serverless/7.png"></p>
<h1 id="Monkey-Optimal-Navigable-Key-Value-Store"><a href="#Monkey-Optimal-Navigable-Key-Value-Store" class="headerlink" title="Monkey: Optimal Navigable Key-Value Store"></a>Monkey: Optimal Navigable Key-Value Store</h1><p><a href="https://nivdayan.github.io/monkeykeyvaluestore.pdf" target="_blank" rel="noopener">https://nivdayan.github.io/monkeykeyvaluestore.pdf</a></p>
<p>个人觉得一篇很好的文章，介绍了 LSM 的 design space。</p>
<h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>Bloom filter 的 FP 率，和最坏情况下的查询开销成正比。</p>
<blockquote>
<p>The insight is that worst-case lookup cost is proportional to the sum of the false positive rates of the Bloom filters across all levels of the LSM-tree.</p>
</blockquote>
<p>对于不同的层，引入不同的 bloomfilter 的大小。</p>
<blockquote>
<p>Monkey allocates memory to filters across different levels so as to minimize this sum.</p>
</blockquote>
<p>设计了一个调优工具。感觉类似 《Fast Scans on Key-Value Stores》里面的思路。</p>
<blockquote>
<p>Furthermore, we map the LSM-tree design space onto a closed-form model that enables co-tuning the merge policy, the buffer size and the filters’ false positive rates to trade among lookup cost, update cost and/or main memory, depending on the workload (proportion oflookups and updates), the dataset (number and size of entries), and the underlying hardware (main memory available, disk vs. flash). We show how to use this model to answer what-if design questions about how changes in environmental parameters impact performance and how to adapt the various LSM-tree design elements accordingly.</p>
</blockquote>
<h2 id="INTRODUCTION-1"><a href="#INTRODUCTION-1" class="headerlink" title="INTRODUCTION"></a>INTRODUCTION</h2><blockquote>
<p>The intuition is that any given amount of main memory allocated to Bloom filters of larger runs brings only a relatively minor benefit in terms of how much it can decrease their false positive rates (to save I/Os). On the contrary, the same amount of memory can have a higher impact in reducing the false positive rate for smaller runs. </p>
</blockquote>
<p>调研 Pareto curve 基于内存容量和工作负载，去寻找到查询和更新开销的平衡点。</p>
<blockquote>
<p>The second key point in Monkey is navigating the Pareto curve to find the optimal balance between lookup cost and update cost under a given main memory budget and application workload (lookup over update ratio). </p>
</blockquote>
<h2 id="BACKGROUND-1"><a href="#BACKGROUND-1" class="headerlink" title="BACKGROUND"></a>BACKGROUND</h2><h3 id="Buffering-Updates"><a href="#Buffering-Updates" class="headerlink" title="Buffering Updates"></a>Buffering Updates</h3><p>首先是下面这张图。</p>
<p>$M_{buffer}$ 等于 $ P \times B \ times E$。E 是 entry 的大小，B 是一个 disk page 中有多少个 entry，P 是内存中有多少个 disk page 用于 buffer。</p>
<p>$ N \times \frac{T-1}{T} $ 是怎么来的呢？其实是个等比数列求和</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 + T + T^2 + ... + T^(L-1) + T^L = N</span><br></pre></td></tr></table></figure>

<p>套一下公式，然后取 <code>T^L-1</code> 直接约等于 <code>T^L</code>，即可得到结果。</p>
<p><img src="/img/dbpaper/monkey/f2.png"></p>
<p>然后，得到另一个 L 关于 T 的公式。</p>
<p><img src="/img/dbpaper/monkey/e1.png"></p>
<p>其中，T 是有一个上限的取值，即 $ \frac{N \times E}{M_{buffer}} $。取这个上限时，L 会退化到 1。因为整个数据库才 $ N \times E $ 这么大，挨个按照 tiered 逻辑 dump 下来就是公式这么多个，然后 T 等于它，那么这一层永远将将好填满。</p>
<h3 id="Merge-Operations"><a href="#Merge-Operations" class="headerlink" title="Merge Operations"></a>Merge Operations</h3><blockquote>
<p>The essential difference is that a leveled LSM-tree merges runs more greedily and therefore gives a tighter bound on the overall number of runs that a lookup has to probe, but this comes at the expense of a higher amortized update cost. </p>
</blockquote>
<p><img src="/img/dbpaper/monkey/f3.png"></p>
<h3 id="Lookups"><a href="#Lookups" class="headerlink" title="Lookups"></a>Lookups</h3><p>查询从 buffer 开始，从低层往高层走。一旦找到第一个满足要求的就可以立即返回，因为层数越往下，数据是越旧的。</p>
<blockquote>
<p>A point lookup starts from the buffer and traverses the levels from lowest to highest (and the runs within those levels from youngest to oldest in the case of tiering). When it finds the first matching entry it terminates. There is no need to look further because entries with the same key at older runs are superseded.</p>
</blockquote>
<ul>
<li>查找一个不存在的值代价可能很高，因为会检查所有 level 中的所有 run</li>
<li>范围查询需要 sort merge 一系列 run，然后丢掉被 override 掉的数据</li>
</ul>
<h3 id="Probing-a-Run"><a href="#Probing-a-Run" class="headerlink" title="Probing a Run"></a>Probing a Run</h3><p>在 1996 年最老的 LSM 设计中，每个 run 是被存储为压缩的 B 树的。</p>
<blockquote>
<p>Over the past two decades, however, main memory has become cheaper, so modern designs simply store an array of fence pointers in main memory with min/max information for every disk page of every run.<br>Maintaining a flat array structure is much simpler and leads to good search performance in memory (binary search as each run is sorted).</p>
</blockquote>
<p>查询的时候，</p>
<ul>
<li>如果是点查，那么就先二分 fencing pointers，然后找到对应的 page</li>
<li>如果是扫表，也还是二分到对应的 page，然后从这个 page 往后读取</li>
</ul>
<p>所以，如果只需要 <code>O(1)</code> 的 disk IO，那么 pointers 的内存大概是 <code>O(N / B)</code>。</p>
<blockquote>
<p>For example, with 16 KB disk pages and 4 byte pointers, the fence pointers are smaller by ≈ 4 orders of magnitude than the raw data size. Stated formally, we denote the amount of main memory occupied by the fence pointers as $M_{pointers}$, and we assume throughout this work that $M_{pointers}$ is <code>O(N / B)</code> thereby guaranteeing that probing a run takes <code>O(1)</code> disk I/O for point lookups.</p>
</blockquote>
<h3 id="Bloom-Filters"><a href="#Bloom-Filters" class="headerlink" title="Bloom Filters"></a>Bloom Filters</h3><p>FPR 即假阳性率，和 entry 的数量正相关，和 bloom filter 的内存占用负相关。如下面公式所示，其中 entries 表示一个 run 中的 entry 的数量，bits 表示内存中用作这个 run 的 Bloomfilter 的大小。</p>
<p><img src="/img/dbpaper/monkey/e2.png"></p>
<p>具体算法可以看<a href="/2017/11/21/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E7%AE%80%E6%98%93%E5%A4%8D%E4%B9%A0/#:~:text=%E6%B5%81%E6%95%B0%E6%8D%AE%E5%8F%96%E6%A0%B7-,Bloom%20Filter,-%E6%88%91%E8%AE%B0%E5%BE%97%E4%B9%8B%E5%89%8D">我的文章</a>。</p>
<p>因为如果出现假阳性，则需要去下一个 sst 文件（tiered）或者下一层（leveled）中去找下一个 run。因此假阳性率实际上就关系到找一个 key 要有多少次 disk IO，从而直接影响到性能。</p>
<p>Rocksdb 中普遍使用 10 bits 给 Bloomfilter，则假阳性率在 1%。</p>
<h3 id="Cost-Analysis"><a href="#Cost-Analysis" class="headerlink" title="Cost Analysis"></a>Cost Analysis</h3><p>如何度量最坏情况呢？</p>
<ul>
<li>对于 update，度量 amortized worst-case I/O cost，主要和 update 之后的 merge 操作有关</li>
<li>对于 lookup，度量 zero-result average worst-case I/O cost。原因是它很常见，并且它的 IO overhead 确实很大</li>
</ul>
<p>对于最坏情况：</p>
<ul>
<li>Tierd<ul>
<li>Lookup 的 IO 正比于 L、T、FPR 三者乘积</li>
<li>Update 的 IO 正比于 L / B</li>
</ul>
</li>
<li>Leveled<ul>
<li>Lookup 的 IO 正比于 L、FPR 二者乘积</li>
<li>Update 的 IO 正比于 T * L / B</li>
</ul>
</li>
</ul>
<p>下面这张表中，从 Log 到 Sorted Array，数据越来越有序，但付出的整理的代价也越来越大。<br><img src="/img/dbpaper/monkey/f4-1.png"></p>
<p>它的计算过程在下面这段话中，其中 $O(e^{-\frac{M_{buffers}}{N}})$ 就是上面的 FPR。其中 $M_{buffers}$ 和 bits 成正比，$N$ 和<br><img src="/img/dbpaper/monkey/f4-2.png"></p>
<h2 id="LSM-TREE-DESIGN-SPACE"><a href="#LSM-TREE-DESIGN-SPACE" class="headerlink" title="LSM-TREE DESIGN SPACE"></a>LSM-TREE DESIGN SPACE</h2><blockquote>
<p>The design space of LSM trees spans everything between a write-optimized log to a read-optimized sorted array.</p>
</blockquote>
<h3 id="Tuning-the-Merge-Policy-and-Size-Ratio"><a href="#Tuning-the-Merge-Policy-and-Size-Ratio" class="headerlink" title="Tuning the Merge Policy and Size Ratio"></a>Tuning the Merge Policy and Size Ratio</h3><p>Figure 4 是一个很有趣的图。虚线部分是 Tiering 策略的 update 和 lookup 开销随着 T 变化的情况。可以看到，Tiering 策略总体是偏向于写优化的，它读写最优的点，即 T = 2 的时候，也将将才和 Leveling 策略打平。</p>
<p><img src="/img/dbpaper/monkey/f4.png"></p>
<p>设置 T 为 2，那么 tiering 和 leveling 这两种策略的更新查找开销是相同的。</p>
<blockquote>
<p>The first insight about the design space is that when the size ratio T is set to 2, the complexities of lookup and update costs for tiering and leveling become identical.</p>
</blockquote>
<p>特别地，当 T 为 1，则总层数 L 为 1。也就是说这个 LSM 树会退化为 log。</p>
<blockquote>
<p>We did not plot the curve to scale, and in reality the markers are much closer to the graph’s origin. However, the shape of the curve and its limits are accurate.</p>
</blockquote>
<h3 id="Tuning-Main-Memory-Allocation"><a href="#Tuning-Main-Memory-Allocation" class="headerlink" title="Tuning Main Memory Allocation"></a>Tuning Main Memory Allocation</h3><blockquote>
<p>The limits of the curve in Figure 4 are determined by the allocation of main memory among the<br>filters $M_{filters}$ and the buffer $M_{buffer}$.</p>
</blockquote>
<h3 id="Design-space-contentions"><a href="#Design-space-contentions" class="headerlink" title="Design space contentions"></a>Design space contentions</h3><ol>
<li>如何将总共 $M_{filters}$ 这么多内存分配给所有的 Bloomfilter？</li>
<li>如何在 buffer 和 filter 之间分配内存？<br> 例如，根据 Figure 4，如果分配在 buffer 上的内存变多，那么 lookup 和 update 的 cost 就会变低，但是会同时提高 Bloomfilter 的 FP 率，从而又实际上提高了 lookup 的 cost。</li>
<li>如何调节 size ratio 也就是 T 和 merge policy？</li>
</ol>
<h3 id="The-State-of-the-Art"><a href="#The-State-of-the-Art" class="headerlink" title="The State of the Art"></a>The State of the Art</h3><blockquote>
<p>All LSM-tree based key-value stores that we know of apply static and suboptimal decisions regarding the above contentions. The Bloom filters are all tuned the same, the Buffer size relative to the Bloom filters size is static, and the size ratio and merge policy are also static</p>
</blockquote>
<h2 id="MONKEY"><a href="#MONKEY" class="headerlink" title="MONKEY"></a>MONKEY</h2><h3 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h3><p><img src="/img/dbpaper/monkey/f5.png"></p>
<h4 id="Design-Knobs"><a href="#Design-Knobs" class="headerlink" title="Design Knobs"></a>Design Knobs</h4><p>Those knobs comprise:</p>
<ul>
<li>the size ratio among levels T<br>the merge policy (leveling vs. tiering)</li>
<li>the false positive rates p1…pL assigned to Bloom filters across different levels</li>
<li>the allocation of main memory M between the buffer $M_{buffer}$ and the filters $M_{filters}$.</li>
</ul>
<h4 id="Minimizing-Lookup-Cost"><a href="#Minimizing-Lookup-Cost" class="headerlink" title="Minimizing Lookup Cost"></a>Minimizing Lookup Cost</h4><p>主要是调整了各层的布隆过滤器的 FPR。</p>
<h4 id="Performance-Prediction"><a href="#Performance-Prediction" class="headerlink" title="Performance Prediction"></a>Performance Prediction</h4><h4 id="Auto-tuning"><a href="#Auto-tuning" class="headerlink" title="Auto tuning"></a>Auto tuning</h4><ul>
<li>在 4.3 中，用了渐进分析的办法</li>
<li>在 4.4 中，定义了最坏情况的吞吐，使用了<ul>
<li>查找和更新开销</li>
<li>查找和更新的比例</li>
<li>在持久化存储中读取和写入的开销</li>
</ul>
</li>
</ul>
<h3 id="Minimizing-Lookup-Cost-1"><a href="#Minimizing-Lookup-Cost-1" class="headerlink" title="Minimizing Lookup Cost"></a>Minimizing Lookup Cost</h3><p>定义 R 是一个返回 0 结果集的点查的 IO 开销，也就是最坏的情况。</p>
<ul>
<li><p>We first show that R is equal to the sum of the false positive rates (FPRs) of all Bloom filters.</p>
</li>
<li><p>We then show how to tune the Bloom filters’ FPRs across different levels to minimize this sum, subject to a constraint on the overall amount of main memory $M_{filters}$.</p>
</li>
<li><p>We assume a fixed entry size E throughout this section</p>
</li>
<li><p>in Appendix C we give a iterative optimization algorithm that quickly finds the optimal FPR assignment even when the entry size is variable or changes over time.</p>
</li>
</ul>
<h4 id="Modeling-Average-Worst-Case-Lookup-Cost"><a href="#Modeling-Average-Worst-Case-Lookup-Cost" class="headerlink" title="Modeling Average Worst-Case Lookup Cost"></a>Modeling Average Worst-Case Lookup Cost</h4><p>要扫描的 run 数，对应了所有 Bloomfilter 的 FPR 之和。如下所示，其中 pi 表示每一层的 FPR。</p>
<p><img src="/img/dbpaper/monkey/e3.png"></p>
<h4 id="Modeling-Main-Memory-Footprint"><a href="#Modeling-Main-Memory-Footprint" class="headerlink" title="Modeling Main Memory Footprint"></a>Modeling Main Memory Footprint</h4><p>可以重写上面 FPR 的公式，得到 bits 和 FPR 的关系。</p>
<p>然后，从上面式子，可以根据每一层的 FPR 即 pi，推导出 $M_{filter}$ 的内存占用。</p>
<p>下面式子的红色框中，通过总的 entry 数量 N 推导出每一层 entry 的数量。因此，求和中的每一项，是每一层的 Bloomfilter 占用的内存。</p>
<p><img src="/img/dbpaper/monkey/e4.png"></p>
<h4 id="Minimizing-Lookup-Cost-with-Monkey"><a href="#Minimizing-Lookup-Cost-with-Monkey" class="headerlink" title="Minimizing Lookup Cost with Monkey"></a>Minimizing Lookup Cost with Monkey</h4><h1 id="Are-You-Sure-You-Want-to-Use-MMAP-in-Your-Database-Management-System？"><a href="#Are-You-Sure-You-Want-to-Use-MMAP-in-Your-Database-Management-System？" class="headerlink" title="Are You Sure You Want to Use MMAP in Your Database Management System？"></a>Are You Sure You Want to Use MMAP in Your Database Management System？</h1><h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><p><a href="https://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener">https://man7.org/linux/man-pages/man2/mmap.2.html</a></p>
<h2 id="INTRODUCTION-2"><a href="#INTRODUCTION-2" class="headerlink" title="INTRODUCTION"></a>INTRODUCTION</h2><p>传统地，数据库使用一个 buffer pool 去维护从二级存储中读上来的数据。但是，现在有另一种使用 mmap 的选择：mmap 使得用户可以把数据库当成始终在内存中一样去使用。当内存不够时，旧的 page 可以被自动 evict 掉（这里应该指的是非 MAP_ANONYMOUS 的情况）。</p>
<p>看到这里，我个人觉得 mmap 有几点问题：</p>
<ul>
<li>绑定了磁盘数据结构和内存数据结构。例如，磁盘中的数据可能会被压缩；内存数据结构更容易使用指针进行跳转。</li>
<li>无法控制落盘的时间。例如 <a href="/2023/07/22/tikv-tidb-thought/#:~:text=%E7%9A%84%20KV%E6%95%B0%E6%8D%AE%E3%80%82-,%E4%B8%80%E4%B8%AA%20Eager%20%E8%90%BD%E7%9B%98%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98,-%E5%B9%B6%E4%B8%8D%E6%98%AF%E6%89%80%E6%9C%89">这里记录的一个问题</a>。</li>
</ul>
<h2 id="BACKGROUND-2"><a href="#BACKGROUND-2" class="headerlink" title="BACKGROUND"></a>BACKGROUND</h2><h3 id="MMAP-Overview"><a href="#MMAP-Overview" class="headerlink" title="MMAP Overview"></a>MMAP Overview</h3><p>下图是一个基于 mmap 的数据库的通常的实现：</p>
<ul>
<li>调用 mmap，得到一个指针</li>
<li>系统分配虚拟地址，但是不会真正的去读文件</li>
<li>程序通过指针去读文件</li>
<li>系统尝试去获取 page</li>
<li>因为目前还没有指向这个虚拟地址的 mapping，所以系统触发一个 page fault，去加载对应内存</li>
<li>系统在 page table 中添加了一个 entry，记录了虚拟地址到物理地址的映射</li>
<li>Initialating CPU core 也会将这个 entry cache 在自己的 local translation lookaside buffer 即 TLB 中来实现加速访问</li>
</ul>
<p><img src="/img/dbpaper/mmap/1.png"></p>
<p>当 munmap 发生时，page 需要被 evict 掉，要做相反的事情：</p>
<ul>
<li>mapping 需要被 OS 移除</li>
<li>CPU core 需要 flush TLB 中的 entry。对于 initiating core 这还是简单的，但同时还需要保证 remote core 中没有 stale entry。因为目前对于 remote TLB 没有 coherence，所以 OS 需要触发一个昂贵的 inter-processor 中断去 flush，这称为 TLB shootdown。</li>
</ul>
<p>这里问了下 GPT 有关 TLB shootdown 的原理：</p>
<ul>
<li>本地 TLB 刷新 ：当一个虚拟到物理地址的映射在某个核的 TLB 中因为内存映射变化而变得过时时，操作系统会先将该过时的映射条目从本地 TLB 中刷新掉。</li>
<li>发送 IPI 中断 ：接着，发起 TLB Shootdown 的核会向其他可能缓存有该过时映射的远程核心发送一种称为 IPI（Inter-Processor Interrupt，处理器间中断）的特殊中断信号。</li>
<li>远程 TLB 刷新并反馈 ：远程核心接收到 IPI 中断后，会执行相应的中断处理程序来检查自己的 TLB，并将其中的过时条目进行无效化处理，完成后会向发起核发送一个完成反馈信号，以告知 TLB Shootdown 已经完成。</li>
</ul>
<p>总而言之，就是页表发生变化的时候，就可能涉及 TLB Shotdown。</p>
<h3 id="POSIX-API"><a href="#POSIX-API" class="headerlink" title="POSIX API"></a>POSIX API</h3><p>介绍一下相关的重要 API：</p>
<ul>
<li>mmap<br>  MAP_SHARED 会导致共享。<br>  MAP_PRIVATE 会导致 COW 机制。变更不会被写入到 backing file 中，也不会被其他 mmap 到同一个文件的进程看到。</li>
<li>madvise<br>  Hint 操作系统需要的访问模式。<br>  MADV_NORMAL：OS 会取需要的页，以及 next 16 和 previous 15 个 page。如果一个 page 是 4KB，会导致 OS 读取 128KB，哪怕这个 caller 真的只需要用一个 page。<br>  MADV_RANDOM：只会读需要的页。<br>  MADV_SEQUENTIAL：从 mmap 的 man 文档中看到的说法是“aggressively read ahead”且“may be freed soon after they are accessed”。</li>
<li>mlock<br>  强制这个页面不能被 evict，一直在内存里面。<br>  POSIX 标准和 Linux 的实现都允许 OS 在任何时候 flush dirty page 到 backing file 上。<br>  因此，这个手段不能用来强制不刷脏页。</li>
<li>msync<br>  强制将 dirty page 刷到 backing file 上。</li>
</ul>
<h3 id="MMAP-Gone-Wrong"><a href="#MMAP-Gone-Wrong" class="headerlink" title="MMAP Gone Wrong"></a>MMAP Gone Wrong</h3><p>一些使用 mmap 的 DB：</p>
<ul>
<li>MonetDB 使用 mmap 存储独立的 column</li>
<li>SQLite 提供一个选项，允许使用 mmap 而不是默认的 read write 系统调用</li>
<li>LMDB 只使用 mmap</li>
</ul>
<p>关于 MonetDB 的情况是，它在早期使用了 mmap，称为 MMAPv1 作为存储引擎。但是遇到一些问题：</p>
<ul>
<li>an overly complex copying scheme to ensure correctness</li>
<li>the inability to perform any compression for data on secondary storage managed the file mapping, the in-memory data layout needed to match the physical representation on secondary storage, leading to wasted space and reduced I/O throughput</li>
</ul>
<p>在 2015 年，MonetDB 使用 WiredTiger 替换了 MMAPv1。后续在 2020 年，WiredTiger 中重新引入了 mmap，但目的只是在特定的情况下减少跨内核和用户空间的开销。</p>
<p>InfluxDB is a time series DBMS that used mmap for file I/O in earlier releases [8]. However, the developers replaced mmap after observing I/O spikes for writes when a database grew larger than a few GB in size, likely due to the overheads associated with page eviction (Section 3.4). They also faced other issues when running in <strong>containerized environments</strong> or on machines without direct-attached storage (e.g., <strong>cloud deployments</strong>), which further precluded the use of mmap in their new IOx storage engine [1].</p>
<p>下面这个 SingleStore 的 case 不是很明白，mmap 的好处之一就是节省系统调用吧。mmap 只需要对需要读的文件调用一次即可，理论上不同的查询是可以 share 的。</p>
<blockquote>
<p>SingleStore removed mmap-based file I/O after encountering poor performance on simple sequential scan queries [32]. The DBMS’s calls to mmap were taking 10–20 ms per query, which accounted for nearly half of the overall query runtime. Upon further investigation, the developers identified the source of the problem as <strong>contention on a shared mmap write lock</strong>. By switching to read system calls, the queries became fully CPU-bound.</p>
</blockquote>
<p>LevelDB 的情况，可以看 NewRandomAccessFile 的实现，可以发现，尽管默认创建 PosixMmapReadableFile，但依然有个 mmap limiter 使得在一些场景下会回退到 PosixRandomAccessFile。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Currently used to limit read-only file descriptors and mmap file usage</span></span><br><span class="line"><span class="comment">// so that we do not run out of file descriptors or virtual memory, or run into</span></span><br><span class="line"><span class="comment">// kernel performance problems for very large databases.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Facebook created RocksDB as a fork of Google’s LevelDB partly due to performance bottlenecks for reads caused by the latter’s use of mmap.</p>
</blockquote>
<h1 id="SLM-DB-Single-Level-Key-Value-Store-with-Persistent-Memory"><a href="#SLM-DB-Single-Level-Key-Value-Store-with-Persistent-Memory" class="headerlink" title="SLM-DB: Single-Level Key-Value Store with Persistent Memory"></a>SLM-DB: Single-Level Key-Value Store with Persistent Memory</h1><p><a href="https://www.usenix.org/system/files/fast19-kaiyrakhmet.pdf" target="_blank" rel="noopener">https://www.usenix.org/system/files/fast19-kaiyrakhmet.pdf</a></p>
<p><a href="https://www.usenix.org/conference/fast19/presentation/kaiyrakhmet" target="_blank" rel="noopener">https://www.usenix.org/conference/fast19/presentation/kaiyrakhmet</a></p>
<h2 id="Presentation"><a href="#Presentation" class="headerlink" title="Presentation"></a>Presentation</h2><p>演讲里面的 Component 可以直接看成是 Level。</p>
<p>这个架构主要是：</p>
<ul>
<li>因为使用了 persistent memory 作为 memtable，所以不需要 WAL 了</li>
<li>引入了一个 global 的 B+ 树索引。这样也不需要一个 multi level merge structure 了</li>
<li>Selective Compaction 机制</li>
</ul>
<p><img src="/img/dbpaper/slm-db/pre1.png"></p>
<p><img src="/img/dbpaper/slm-db/pre2.png"></p>
<p>Memtable</p>
<p><img src="/img/dbpaper/slm-db/pre3.png"></p>
<p>当 Immutable 被 flush 到 disk 的时候，会写入 B+ 树的索引。</p>
<p><img src="/img/dbpaper/slm-db/pre4.png"></p>
<p>Compaction 的另一个目的是 Range Search 需要的顺序性。没怎么看明白</p>
<p><img src="/img/dbpaper/slm-db/pre5.png"></p>
<p><img src="/img/dbpaper/slm-db/pre6.png"></p>
<p>Live Key ratio selection 有点像 TiFlash 的 PS3 的实现。</p>
<p><img src="/img/dbpaper/slm-db/pre7.png"></p>
<p>从论文里补充下计算方式：</p>
<ul>
<li>the total number of KV pairs stored in s is computed at creation, and initially the number of valid KV pairs is equal to the total number of KV pairs in s</li>
<li>when we update a pointer to the new location object for the key in the B+-tree, we decrease the number of valid KV pairs in s</li>
</ul>
<p>简单来说，如果 SST 里面的 kv pair 陈旧了，就说明它的新版本肯定被写到一个新的 SST 里面了。B+ 树能体现出这个变更。</p>
<p>Compaction 的过程如下所示，主要是两个线程，一个线程 flush，一个线程构建 index。有点类似流水线一样。</p>
<p><img src="/img/dbpaper/slm-db/pre8.png"></p>
<h3 id="个人理解"><a href="#个人理解" class="headerlink" title="个人理解"></a>个人理解</h3><p>在内存中建立的 B+ tree 提高了 read 的效率，避免了之前一层一层往下找的开销。这样，就可以激进地将 LSM 减少到一层，减少 Compaction 的写放大。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h2 id="Single-Level-Merge-DB-SLM-DB"><a href="#Single-Level-Merge-DB-SLM-DB" class="headerlink" title="Single-Level Merge DB (SLM-DB)"></a>Single-Level Merge DB (SLM-DB)</h2><h3 id="Selective-Compaction"><a href="#Selective-Compaction" class="headerlink" title="Selective Compaction"></a>Selective Compaction</h3><p>compaction candidate list</p>
<p>overlapping ratio：对于 SST s，计算它和每个其他的 SST t 的 overlapping ratio。这是根据 s 和 t 各自的 head 和 tail 来算的，所以是比较快的，不需要遍历整个 SST。作者提出了一个公式，如果这个公式算出来是小于等于 0 的，那么就说明不 overlap。数据库会在后台异步地 compact s 和它 overlapping ratio 最大的 SST。</p>
<blockquote>
<p>When merging multiple SSTable files, we need to check if each KV pair in the files is valid or obsolete, which is done<br>by searching the key in the B+-tree. If it is valid, we mergesort it with the other valid KV pairs. If the key does not exist in the B+-tree or the key is currently stored in some other SSTable, we drop that obsolete KV pair from merging to a new file.</p>
</blockquote>
<p>leaf node 的这个优化指的应该是合并小文件。</p>
<blockquote>
<p>the selection based on the leaf node scans in the B+-tree attempts to improve the sequentiality of KVs stored in L0.</p>
</blockquote>
<p>During the scan, we count the number of unique SSTable files, where scanned keys are stored. If the number<br>of unique files is larger than the threshold, called the leaf node threshold, we add those files to the compaction candidate list. In this work, the number of keys to scan for a leaf node scan is decided based on two factors, the average number of keys stored in a single SSTable (which depends on the size of a value) and the number of SSTables to scan at once.</p>
<p>对于范围查询，将它分为多个 subrange。每个 subrange 包含指定数量的 key。</p>
<blockquote>
<p>we keep track of the number of unique files accessed. Once the range query operation is done, we find the sub-range with the maximum number of unique files. If the number of unique files is larger than the threshold, called the sequentiality degree threshold, we add those unique files to the compaction candidate list.</p>
</blockquote>
<p>This feature is useful in improving sequentiality especially for requests with Zipfian distribution (like YCSB [17]) where some keys are more frequently read and scanned.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div></div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/img/fkm/wxfk.jpg" alt="Calvin Neo WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/img/fkm/zfbfk.jpg" alt="Calvin Neo Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/数据库/" rel="tag"># 数据库</a>
          
            <a href="/tags/论文阅读/" rel="tag"># 论文阅读</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/12/21/db-compression/" rel="next" title="数据库中的压缩技术">
                <i class="fa fa-chevron-left"></i> 数据库中的压缩技术
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/12/29/rocksdb-compaction/" rel="prev" title="RocksDB 的 Compaction 策略">
                RocksDB 的 Compaction 策略 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/favicon.jpg"
               alt="Calvin Neo" />
          <p class="site-author-name" itemprop="name">Calvin Neo</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">247</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">153</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CalvinNeo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/CalvinNeo0" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1568200035" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://xqq.im/" title="xqq" target="_blank">xqq</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.lovelywen.com/" title="wenwen" target="_blank">wenwen</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://smlight.github.io/blog/" title="zyyyyy" target="_blank">zyyyyy</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PolarDB-Serverless-A-Cloud-Native-Database-for-Disaggregated-Data-Centers"><span class="nav-number">1.</span> <span class="nav-text">PolarDB Serverless: A Cloud Native Database for Disaggregated Data Centers</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#INTRODUCTION"><span class="nav-number">1.1.</span> <span class="nav-text">INTRODUCTION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BACKGROUND"><span class="nav-number">1.2.</span> <span class="nav-text">BACKGROUND</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PolarDB"><span class="nav-number">1.2.1.</span> <span class="nav-text">PolarDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Disaggregated-Data-Centers"><span class="nav-number">1.2.2.</span> <span class="nav-text">Disaggregated Data Centers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Serverless-Databases"><span class="nav-number">1.2.3.</span> <span class="nav-text">Serverless Databases</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DESIGN"><span class="nav-number">1.3.</span> <span class="nav-text">DESIGN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Disaggregated-Memory"><span class="nav-number">1.3.1.</span> <span class="nav-text">Disaggregated Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Remote-Memory-Access-Interface"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">Remote Memory Access Interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Remote-Memory-Management"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">Remote Memory Management</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Page-Array-PA"><span class="nav-number">1.3.1.2.1.</span> <span class="nav-text">Page Array(PA)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Page-Address-Table-PAT"><span class="nav-number">1.3.1.2.2.</span> <span class="nav-text">Page Address Table (PAT)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Page-Invalidation-Bitmap-PIB"><span class="nav-number">1.3.1.2.3.</span> <span class="nav-text">Page Invalidation Bitmap (PIB)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Page-Materialization-Offloading"><span class="nav-number">1.3.2.</span> <span class="nav-text">Page Materialization Offloading</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Monkey-Optimal-Navigable-Key-Value-Store"><span class="nav-number">2.</span> <span class="nav-text">Monkey: Optimal Navigable Key-Value Store</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Abstract"><span class="nav-number">2.1.</span> <span class="nav-text">Abstract</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#INTRODUCTION-1"><span class="nav-number">2.2.</span> <span class="nav-text">INTRODUCTION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BACKGROUND-1"><span class="nav-number">2.3.</span> <span class="nav-text">BACKGROUND</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Buffering-Updates"><span class="nav-number">2.3.1.</span> <span class="nav-text">Buffering Updates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Merge-Operations"><span class="nav-number">2.3.2.</span> <span class="nav-text">Merge Operations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lookups"><span class="nav-number">2.3.3.</span> <span class="nav-text">Lookups</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Probing-a-Run"><span class="nav-number">2.3.4.</span> <span class="nav-text">Probing a Run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bloom-Filters"><span class="nav-number">2.3.5.</span> <span class="nav-text">Bloom Filters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cost-Analysis"><span class="nav-number">2.3.6.</span> <span class="nav-text">Cost Analysis</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LSM-TREE-DESIGN-SPACE"><span class="nav-number">2.4.</span> <span class="nav-text">LSM-TREE DESIGN SPACE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-the-Merge-Policy-and-Size-Ratio"><span class="nav-number">2.4.1.</span> <span class="nav-text">Tuning the Merge Policy and Size Ratio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-Main-Memory-Allocation"><span class="nav-number">2.4.2.</span> <span class="nav-text">Tuning Main Memory Allocation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Design-space-contentions"><span class="nav-number">2.4.3.</span> <span class="nav-text">Design space contentions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-State-of-the-Art"><span class="nav-number">2.4.4.</span> <span class="nav-text">The State of the Art</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MONKEY"><span class="nav-number">2.5.</span> <span class="nav-text">MONKEY</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#综述"><span class="nav-number">2.5.1.</span> <span class="nav-text">综述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Design-Knobs"><span class="nav-number">2.5.1.1.</span> <span class="nav-text">Design Knobs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Minimizing-Lookup-Cost"><span class="nav-number">2.5.1.2.</span> <span class="nav-text">Minimizing Lookup Cost</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Performance-Prediction"><span class="nav-number">2.5.1.3.</span> <span class="nav-text">Performance Prediction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Auto-tuning"><span class="nav-number">2.5.1.4.</span> <span class="nav-text">Auto tuning</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Minimizing-Lookup-Cost-1"><span class="nav-number">2.5.2.</span> <span class="nav-text">Minimizing Lookup Cost</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Modeling-Average-Worst-Case-Lookup-Cost"><span class="nav-number">2.5.2.1.</span> <span class="nav-text">Modeling Average Worst-Case Lookup Cost</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Modeling-Main-Memory-Footprint"><span class="nav-number">2.5.2.2.</span> <span class="nav-text">Modeling Main Memory Footprint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Minimizing-Lookup-Cost-with-Monkey"><span class="nav-number">2.5.2.3.</span> <span class="nav-text">Minimizing Lookup Cost with Monkey</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Are-You-Sure-You-Want-to-Use-MMAP-in-Your-Database-Management-System？"><span class="nav-number">3.</span> <span class="nav-text">Are You Sure You Want to Use MMAP in Your Database Management System？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mmap"><span class="nav-number">3.1.</span> <span class="nav-text">mmap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#INTRODUCTION-2"><span class="nav-number">3.2.</span> <span class="nav-text">INTRODUCTION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BACKGROUND-2"><span class="nav-number">3.3.</span> <span class="nav-text">BACKGROUND</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MMAP-Overview"><span class="nav-number">3.3.1.</span> <span class="nav-text">MMAP Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX-API"><span class="nav-number">3.3.2.</span> <span class="nav-text">POSIX API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MMAP-Gone-Wrong"><span class="nav-number">3.3.3.</span> <span class="nav-text">MMAP Gone Wrong</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SLM-DB-Single-Level-Key-Value-Store-with-Persistent-Memory"><span class="nav-number">4.</span> <span class="nav-text">SLM-DB: Single-Level Key-Value Store with Persistent Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Presentation"><span class="nav-number">4.1.</span> <span class="nav-text">Presentation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#个人理解"><span class="nav-number">4.1.1.</span> <span class="nav-text">个人理解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">4.2.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Single-Level-Merge-DB-SLM-DB"><span class="nav-number">4.3.</span> <span class="nav-text">Single-Level Merge DB (SLM-DB)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Selective-Compaction"><span class="nav-number">4.3.1.</span> <span class="nav-text">Selective Compaction</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Calvin Neo</span>
  <span> &nbsp; Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></span>
</div>
<div>
  <span><a href="/about/yytl/">版权声明</a></span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse 
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.calvinneo.com/2024/12/25/database-paper-6/';
          this.page.identifier = '2024/12/25/database-paper-6/';
          this.page.title = 'Database paper part 6';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://calvinneo.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      $('#local-search-input').focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
