<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="游戏," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="帝国时代2的AI是比较弱智的，因此网上出现了一些比较厉害的AI，例如Barbarian（野蛮人）、The Horde等，甚至出现了一个AI Ladder对市面上的AI进行排行。恰逢国庆，打算首先来研究一下帝国时代AI的原始DSL以及UserPatch补丁修改后增加的功能，并且结合一些著名AI探讨一些常用的手法。">
<meta name="keywords" content="游戏">
<meta property="og:type" content="article">
<meta property="og:title" content="帝国时代AI开发">
<meta property="og:url" content="http://www.calvinneo.com/2017/10/03/帝国时代AI开发/index.html">
<meta property="og:site_name" content="Calvin&#39;s Marbles">
<meta property="og:description" content="帝国时代2的AI是比较弱智的，因此网上出现了一些比较厉害的AI，例如Barbarian（野蛮人）、The Horde等，甚至出现了一个AI Ladder对市面上的AI进行排行。恰逢国庆，打算首先来研究一下帝国时代AI的原始DSL以及UserPatch补丁修改后增加的功能，并且结合一些著名AI探讨一些常用的手法。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.calvinneo.com/img/aoeai/norules.png">
<meta property="og:updated_time" content="2017-10-18T08:32:31.173Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="帝国时代AI开发">
<meta name="twitter:description" content="帝国时代2的AI是比较弱智的，因此网上出现了一些比较厉害的AI，例如Barbarian（野蛮人）、The Horde等，甚至出现了一个AI Ladder对市面上的AI进行排行。恰逢国庆，打算首先来研究一下帝国时代AI的原始DSL以及UserPatch补丁修改后增加的功能，并且结合一些著名AI探讨一些常用的手法。">
<meta name="twitter:image" content="http://www.calvinneo.com/img/aoeai/norules.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.calvinneo.com/2017/10/03/帝国时代AI开发/"/>





  <title>帝国时代AI开发 | Calvin's Marbles</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Calvin's Marbles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.calvinneo.com/2017/10/03/帝国时代AI开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Calvin Neo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Calvin's Marbles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                帝国时代AI开发
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-03T21:40:56+08:00">
                2017-10-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/03/帝国时代AI开发/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/03/帝国时代AI开发/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>帝国时代2的AI是比较弱智的，因此网上出现了一些比较厉害的AI，例如Barbarian（野蛮人）、The Horde等，甚至出现了<a href="http://aok.heavengames.com/cgi-bin/aokcgi/display.cgi?action=st&amp;fn=28&amp;tn=40898&amp;st=855" target="_blank" rel="noopener">一个AI Ladder</a>对市面上的AI进行排行。恰逢国庆，打算首先来研究一下帝国时代AI的原始DSL以及UserPatch补丁修改后增加的功能，并且结合一些著名AI探讨一些常用的手法。</p>
<a id="more"></a>
<h1 id="Native-DSL简介"><a href="#Native-DSL简介" class="headerlink" title="Native DSL简介"></a>Native DSL简介</h1><p>帝国时代2 AOK（即红帽子）版本的DSL文档可以从<a href="http://d.pr/f/lpZg" target="_blank" rel="noopener">这里下载</a>，翔鹰帝国提供了<a href="http://www.hawkaoc.net/bbs/thread-4697-1-1.html" target="_blank" rel="noopener">有点奇怪的中文翻译</a>。此外外国一款针对1.0c版本的UserPatch加强了DSL，有了一些新的特性，目前已更新到v1.4，它的官网是userpatch.aiscripters.net。<br>一套ai包含两个文件，.per即personality文件，包含着所有的ai部分，ai文件一般只做占位符类似的作用。<br>如果per文件是空的，那么就会弹出一个错误，并且农民会四处跑，进行牧羊。<br><img src="/img/aoeai/norules.png" alt=""></p>
<h2 id="def语法"><a href="#def语法" class="headerlink" title="def语法"></a>def语法</h2><p>总的来说，这份DSL类似于lisp语言，主要由下面的<code>defrule</code>语句构成<br><figure class="highlight hy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span>  </span><br><span class="line">	(<span class="name"><span class="builtin-name">some</span></span> facts)  </span><br><span class="line">	=&gt; </span><br><span class="line">	(<span class="name"><span class="builtin-name">some</span></span> action takes place) </span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>一个defrule可以看做地图编辑器里面的一个触发项。下面的fact/action可以包含若干个条件/动作。<br>rule一旦被定义，系统就会不断轮询检查是否符合facts所描述的条件，如果符合，就执行action语句。脚本不会像C++一样只采用最匹配的规则，如下面两个规则都是适用的，所以我们细化战略时，必须同时写真条件和假条件。<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(defrule</span><br><span class="line">	(cc-players-unit-<span class="built_in">type</span>-<span class="built_in">count</span> any-human-enemy town-center &gt;= <span class="number">1</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(chat-to-all <span class="string">"aaa"</span>)</span><br><span class="line">)</span><br><span class="line">(defrule</span><br><span class="line">	(current-age == dark-age)</span><br><span class="line">	(cc-players-unit-<span class="built_in">type</span>-<span class="built_in">count</span> any-human-enemy town-center &gt;= <span class="number">1</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(chat-to-all <span class="string">"bbb"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>对于一些只想执行一次的语句就可以通过最末尾的<code>(disable-self)</code>来禁用这条规则。<br>除了defrule，还有defconst，用来定义常数，defconst可以重复定义（如果值相同）。</p>
<h2 id="load语法"><a href="#load语法" class="headerlink" title="load语法"></a>load语法</h2><p>这个有点类似于C++中的include了。<br>常常针对各个民族的特点包括陆/海/游/移民等不同形式各写一套ai，然后在一个总的per文件里面针对不同情况来load。</p>
<h3 id="随机加载"><a href="#随机加载" class="headerlink" title="随机加载"></a>随机加载</h3><p>可以通过<code>load-random</code>指令按照一定比率随机加载per文件，这样可以做到一定程度的随机ai。</p>
<h3 id="条件加载"><a href="#条件加载" class="headerlink" title="条件加载"></a>条件加载</h3><p>通过<code>#load-if-defined</code>和<code>#load-if-not-defined</code>可以实现条件加载。这两个命令接受System-defined symbols，来自于开始游戏时的设定，例如初始资源选项就有LOW-RESOURCES-START/MEDIUM-RESOURCES-START/HIGH-RESOURCES-START三种，分别对应了游戏下拉列表里面的三个选项。<br>条件加载有点类似于C++中的预处理指令，但实际上帝国时代引擎中没有预处理阶段，条件加载所包裹的指令只是不被load，但会被parse的。<br>不加载一些rule能够有效提高性能，这样轮询的对象就会少一点。</p>
<h2 id="通配符（wildcard）"><a href="#通配符（wildcard）" class="headerlink" title="通配符（wildcard）"></a>通配符（wildcard）</h2><p><code>any-</code>和<code>every-</code>可以引导通配符，其中<code>any-</code>引导的需要一个为真，<code>every-</code>引导的则需要全部为真。特别地<code>this-any-</code>里面有any，但实际上它是variable。<br>通配符包括      any-ally、any-computer、any-computer-ally、any-computer-enemy、any-computer-neutral、any-enemy、any-human、any-human-ally、any-human-enemy、any-human-neutral、any-neutral、every-ally、every-computer、every-enemy、every-human、every-neutral<br>根据科技的研究骑士可以升级为重装骑士和圣殿骑士，这时候就需要使用<code>-line</code>是这个通配符，<code>knight-line</code>表示骑士，这样我们就不需要去判断是否研究过cavalier或者paladin了。</p>
<h2 id="facts、actions、parameters、variables和goal"><a href="#facts、actions、parameters、variables和goal" class="headerlink" title="facts、actions、parameters、variables和goal"></a>facts、actions、parameters、variables和goal</h2><p>事实(facts)一般用作rule的条件。例如<code>military-population</code>这个fact表示自己此时的军事人口。不过我们不能把这个值取出来，只能用一个比较运算符和某个立即量进行比较，形成一个predicate。例如<code>military-population &gt; 10</code>。<br>fact或action的参数称为parameter。<br><code>this-</code>引导的为变量(variable)，variable的生存空间只存在于当前规则中，并且variable都是由系统隐式定义的，例如<code>this-any-enemy</code>表示选定的任一敌人。<br>那么这个<code>this-any-enemy</code>具体是是怎么决定的呢？这由facts中的通配符来匹配得到，例如在facts中匹配了哥特文明的任意敌人，那么下面的<code>this-any-enemy</code>就指的上面的敌人。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">   (<span class="name">players-civ</span> any-enemy gothic) </span><br><span class="line">   =&gt;</span><br><span class="line">   (<span class="name">chat-to-player</span> this-any-enemy <span class="string">"I know you are a Goth"</span>)</span><br><span class="line">   (<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>需要再次强调的是在这个规则之外，本次匹配得到的<code>this-any-enemy</code>就不能适用了。<br>有没有用户能控制的全局的变量呢？最接近的应该是目标(goal)。goal可以由<code>(set-goal goal-id value)</code>来定义，<code>goal-id</code>范围一般是从1-70（HD版本），为了方便阅读，常使用defconst常数。可惜的是goal的读取很不方便，因为它只能通过<code>(goal goal-id value)</code>来判断是否相等，甚至连比较运算符都不支持。</p>
<h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><p>注意enable之后必须要disable掉当前语句，不然会一直enable导致无法trigger</p>
<h2 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h2><p>游戏难度的关系运算符是和想象相反的，即easiest&gt;easy&gt;moderate&gt;hard&gt;hardest。</p>
<h2 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h2><p><code>sn-</code>引导的为策略。<br>城镇规模<code>town-size</code>指的是一个城镇建筑所覆盖的面积。</p>
<h2 id="escrow预留资源"><a href="#escrow预留资源" class="headerlink" title="escrow预留资源"></a>escrow预留资源</h2><p><code>escrow-amount</code>命令可以将某一类的资源预留一部分作为储备，这样所有的资源会被分成两块，便于管理。<br><code>release-escrow</code>可以取消预留资源</p>
<h1 id="AI基本操作"><a href="#AI基本操作" class="headerlink" title="AI基本操作"></a>AI基本操作</h1><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>我们可以看到大多数时候，变量都是不能直接获取值的，而是通过比较是否相等（goal）或者比较运算符比较（如building-type-count）实现，对这些数值的调试只能写一条defrule然后在里面判断数值输出。<br>但是还有一类<code>sn-</code>开头的strategic-number，这个可以通过<code>chat-trace</code>这条指令输出。</p>
<h3 id="使用taunt调试"><a href="#使用taunt调试" class="headerlink" title="使用taunt调试"></a>使用taunt调试</h3><p><code>taunt-detected</code>和<code>acknowledge-taunt</code>这两个可以实现由用户输入某个数字taunt，然后输出相应值的功能。</p>
<h2 id="补人口"><a href="#补人口" class="headerlink" title="补人口"></a>补人口</h2><p>默认1.5倍时间下，TC造一个农民大概在13秒左右，一个农民造房子大概在15秒左右，所以当人口差两个的时候就需要造房子了<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">(<span class="name">can-build</span> house)</span><br><span class="line">(<span class="name">housing-headroom</span> &lt; <span class="number">2</span>) </span><br><span class="line">(<span class="name">population-headroom</span> &gt; <span class="number">3</span>)</span><br><span class="line">=&gt;</span><br><span class="line">(<span class="name">build</span> house)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>can-build</code>会检查该building是否符合当前的文明、科技树以及资源量（减去escrow预留的资源）。不过即使不加<code>can-build</code>，电脑也不会在文明、科技、资源量不满足的情况下造，而是作为一次失败的build尝试。一旦一次build失败了，<a href="https://steamcommunity.com/sharedfiles/filedetails/?id=137724532" target="_blank" rel="noopener">此趟执行的所有<code>build x</code>都不会被运行了</a>，即使后来条件全部满足。<br>类似的还有<code>can-train</code>和<code>can-research</code>，不过这两个还要注意建筑物在研究科技/造兵时被占用的问题。<br>如果不幸卡农民了，可以升级织布机<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">current-age</span> == dark-age)</span><br><span class="line">	(<span class="name"><span class="builtin-name">not</span></span> (<span class="name">can-train</span> villager))</span><br><span class="line">	(<span class="name">can-research</span> ri-loom)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">research</span> ri-loom)</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h2 id="城镇规模-TSA-进攻"><a href="#城镇规模-TSA-进攻" class="headerlink" title="城镇规模(TSA)进攻"></a>城镇规模(TSA)进攻</h2><p>一般的进攻有<code>(attack-now)</code>语句，该语句会造成一队士兵以编队形式过来进攻，不过有些问题，例如在编队行进过程中受到进攻也不还手。由于<code>attack-now</code>是一队一队地出发的，所以可以通过改小<code>sn-percent-attack-soldiers</code>然后多次<code>attack-now</code>实现多波的、相互呼应的进攻。<br>TSA即Town Size Attack，相对于<code>(attack-now)</code>的直来直去，TSA进攻更分散、更操作性一点。它通过增加城镇的面积，这样己方就会对城镇面积内的敌人进行攻击。<br>注意要区分TSA和日常随着经济发展的城镇增长，城镇增长相对TSA还要额外扩大<code>sn-camp-max-distance</code>和<code>sn-mill-max-distance</code>用以获得更多资源。<br>为了测试，我们可以做一个场景地图。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string"> </span> (<span class="string">true)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-home-</span><span class="string">exploration-time </span>0)</span><br><span class="line">	</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">town-size </span><span class="string">255)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-number-</span><span class="string">attack-groups </span><span class="string">200)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">attack-group-</span><span class="string">size </span><span class="string">200)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">attack-group-</span><span class="string">size </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-attack-</span><span class="string">intelligence </span>1) </span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enemy-</span><span class="string">sighted-response-</span><span class="string">distance </span><span class="string">200)</span> </span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-disable-</span><span class="string">attack-groups </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">attack-soldiers </span><span class="string">100)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>sn-attack-intelligence</code>表示智能进攻系统。该系统尝试在攻击时躲避敌人单位，尝试从多角度进攻。配合<code>sn-attack-coordination</code>设为2能够实现多线作战效果。<br><code>sn-disable-attack-groups</code>会禁用自动进攻编组，TSA必须不禁用。类似的选项还有<code>sn-disable-defend-groups</code>。<br>结果调试发现，首先所有的兵力沿着城镇方向散开，直到有一个军事单位发现敌人。当战斗单位还存在的时候TSA农民是不怎么参与战斗的，即使设置了<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">set-strategic-number</span> <span class="string">sn-allow-</span><span class="string">civilian-defense </span>3)</span><br><span class="line">(<span class="built_in">set-strategic-number</span> <span class="string">sn-allow-</span><span class="string">civilian-offense </span>2)</span><br><span class="line">(<span class="built_in">set-strategic-number</span> <span class="string">sn-number-</span><span class="string">civilian-militia </span><span class="string">200)</span></span><br></pre></td></tr></table></figure></p>
<p>但如果放到一个纯农民的地图里面，农民就都会上去搏。<br><code>sn-percent-attack-soldiers</code>似乎并不对TSA有作用，它仅针对<code>attack-now</code>命令，指的是进攻士兵占防守士兵的比例。官方说明中提到用它时最好不用<code>sn-number-defend-groups</code>（注意是defend）。<br><code>sn-enemy-sighted-response-distance</code>指敌人攻击自己时，什么范围内的己方单位会作出反应，为了调试效果，我们把这个值设得非常大。</p>
<p><code>sn-special-attack-type1(2/3)</code>是个很有用的命令，它设置了首要的攻击目标（单位、建筑等），在UP的注释中却有不同的说明，当它为1时会攻击僧侣。我在论坛上确认了使用UP时UP的注释是正确的，此外原版DSL中更本就没有<code>sn-special-attack-type2</code>和<code>sn-special-attack-type3</code><br>与之对应的是<code>sn-gold-defend-priority</code>等一系列防守重要性等级策略，从0到7防守力度越来越大。</p>
<p><code>sn-number-attack-groups</code>、<code>sn-minimum-attack-group-size</code>、<code>sn-maximum-attack-group-size</code>及<code>sn-attack-group-size-randomness</code>是一套指令。</p>
<h2 id="修建围墙"><a href="#修建围墙" class="headerlink" title="修建围墙"></a>修建围墙</h2><p>围家是帝国时代做经济的一个军事支撑，如果在前方给敌人足够压力可以借助TC和军事建筑，如果想直城或直帝则需要木头墙+石墙围一道。<br>围墙建造第一步是<code>enable-wall-placement</code>这个命令，这个命令会通知将来的建筑离未来的围墙至少距离1格(tile)，因此最好在初始化中就做好。<code>enable-wall-placement</code>带一个参数<code>perimeter</code>，设为1就是小围，2是大围。<br><code>build-wall</code>是建造围墙命令<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">    (<span class="name">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">    (<span class="name">enable-wall-placement</span> <span class="number">1</span>)</span><br><span class="line">    (<span class="name">disable-self</span>)</span><br><span class="line">)</span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">    (<span class="name">current-age</span> &gt;= castle-age)</span><br><span class="line">    (<span class="name">stone-amount</span> &gt; <span class="number">300</span>)</span><br><span class="line">    (<span class="name">can-build-wall</span> <span class="number">1</span> stone-wall-line)</span><br><span class="line">=&gt;</span><br><span class="line">    (<span class="name">build-wall</span> <span class="number">1</span> stone-wall-line)</span><br><span class="line">)</span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">    (<span class="name"><span class="builtin-name">or</span></span></span><br><span class="line">        (<span class="name">wall-completed-percentage</span> <span class="number">2</span> &gt;= <span class="number">20</span>)</span><br><span class="line">        (<span class="name">wall-completed-percentage</span> <span class="number">1</span> &gt;= <span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line">    (<span class="name"><span class="builtin-name">or</span></span></span><br><span class="line">        (<span class="name">can-build-gate</span> <span class="number">2</span>)</span><br><span class="line">        (<span class="name">can-build-gate</span> <span class="number">1</span>)</span><br><span class="line">    )</span><br><span class="line">=&gt;</span><br><span class="line">    (<span class="name">build-gate</span> <span class="number">2</span>)</span><br><span class="line">    (<span class="name">build-gate</span> <span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h2 id="小围技术"><a href="#小围技术" class="headerlink" title="小围技术"></a>小围技术</h2><p>小围技术包含两个方面，一是如何让房子等技术修成圈，另一个是如何让农民在第一个建筑没修完时赶快桥第二个建筑</p>
<h1 id="Native-AI赏析之BOOM-II"><a href="#Native-AI赏析之BOOM-II" class="headerlink" title="Native AI赏析之BOOM II"></a>Native AI赏析之BOOM II</h1><p>BOOM II ai是一个比较厉害的ai，特点是疯狂爆兵。和他打了几把，它不喜欢杀敌人的农民，后期也不会清理空闲农民（倒是UserPatch里面有个相关的清理命令），多人的时候不太喜欢在后面圈贸易，所以经济有点吃亏，黑暗时代不喜欢拉猪赶鹿可能是AI的一个通病，可能做不到这么细致。</p>
<h2 id="防守塔爆"><a href="#防守塔爆" class="headerlink" title="防守塔爆"></a>防守塔爆</h2><p><code>GOAL-DEF-TRUCH</code>指的是防御塔爆（defend tower rush）</p>
<h3 id="塔爆状态流"><a href="#塔爆状态流" class="headerlink" title="塔爆状态流"></a>塔爆状态流</h3><p>第一步是发现修塔，如果在封建时代前的前期（前1200秒）内探查到敌人修塔，就切换<code>GOAL-DEF-TRUCH</code>到7。<br><code>(goal GOAL-ADDRESOURCE 1)</code>这个条件我不太明白是怎么回事<br>值得注意的是<code>building-type-count</code>和 <code>building-type-count-total</code>，前一个只计算现存的建筑数，后一个计算包括正在队列（正在建造）中的建筑数。注意摧毁了的建筑不会增加到这个里面。<br><code>unit-type-count</code>和 <code>unit-type-count-total</code>的区别也在此，不过<code>unit-</code>不仅对建筑用，也可以对军队等单位用。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">goal</span> GOAL-ADDRESOURCE <span class="number">1</span>)</span><br><span class="line">	(<span class="name">game-time</span> &lt; <span class="number">1200</span>)</span><br><span class="line">	(<span class="name">current-age</span> &lt;= feudal-age)</span><br><span class="line">	(<span class="name">goal</span> GOAL-DEF-TRUCH <span class="number">0</span>)</span><br><span class="line">	(<span class="name">players-building-type-count</span> any-human-enemy watch-tower &gt;= <span class="number">1</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">set-goal</span> GOAL-DEF-TRUCH <span class="number">7</span>)</span><br><span class="line">	(<span class="name">chat-to-player</span> this-any-human-enemy <span class="string">"修塔..."</span>)</span><br><span class="line">	(<span class="name">set-strategic-number</span> sn-maximum-town-size <span class="number">35</span>)</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>第二步是发现塔爆<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">goal </span><span class="string">GOAL-ADDRESOURCE </span>1)</span><br><span class="line">	(<span class="string">game-time </span>&lt; <span class="string">1000)</span></span><br><span class="line">	(<span class="string">current-age </span>&lt;= <span class="string">feudal-age)</span></span><br><span class="line">	(<span class="string">goal </span><span class="string">GOAL-DEF-</span><span class="string">TRUCH </span>7)</span><br><span class="line">	(<span class="string">players-military-</span><span class="string">population </span><span class="string">any-human-</span><span class="string">enemy </span>&lt;= 1)</span><br><span class="line">	(<span class="string">enemy-buildings-</span><span class="string">in-town)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="string">chat-to-</span><span class="string">player </span><span class="string">this-any-</span><span class="string">human-enemy </span><span class="string">"塔暴?!"</span>)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">GOAL-DEF-</span><span class="string">TRUCH </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">town-size </span><span class="string">20)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-camp-</span><span class="string">max-distance </span><span class="string">25)</span></span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">GOAL-SPECIAL-</span><span class="string">AID </span>1)</span><br><span class="line">	(<span class="string">disable-timer </span><span class="string">TIMER-SPECIAL-</span><span class="string">AID)</span></span><br><span class="line">	(<span class="string">enable-timer </span><span class="string">TIMER-SPECIAL-</span><span class="string">AID </span><span class="string">300)</span></span><br><span class="line">	(<span class="string">disable-self)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>首先需要经过第一步<code>GOAL-DEF-TRUCH</code>已经到7，然后敌人的军事人口应该小于等于1（相对于黑快的大于等于4），并且有建筑在城镇范围内部了。这时候切换<code>GOAL-DEF-TRUCH</code>到1，并且调整城镇规模，此外切换<code>GOAL-SPECIAL-AID</code>到1，并启动定时器<code>TIMER-SPECIAL-AID</code>。<br>此外脚本对前置塔攻的情况进行了特殊处理。前置塔攻相比塔爆多了军事人口，更厉害。在处理时切换<code>GOAL-DEF-TRUCH</code>到2，启动SPECIAL-AID一套流程，但不调整城镇规模。<br>第三步，检查敌人是否使用木墙或者石墙围，并根据具体情况不同重置<code>TIMER-SPECIAL-AID</code>为400（前置塔攻490）、900、1600<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">goal</span> GOAL-DEF-TRUCH <span class="number">1</span>)</span><br><span class="line">	(<span class="name">players-building-type-count</span> any-human-enemy watch-tower &gt;= <span class="number">1</span>)</span><br><span class="line">	(<span class="name">players-building-type-count</span> any-human-enemy stone-wall &gt;= <span class="number">2</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">chat-to-player</span> this-any-human-enemy <span class="string">"24你死定了!!"</span>)</span><br><span class="line">	(<span class="name">set-goal</span> GOAL-SPECIAL-AID <span class="number">1</span>)</span><br><span class="line">	(<span class="name">disable-timer</span> TIMER-SPECIAL-AID)</span><br><span class="line">	(<span class="name">enable-timer</span> TIMER-SPECIAL-AID <span class="number">900</span>)</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>下面讨论ai防御塔爆的行为，这在Defend Truch部分有定义。这些防御行为的产生条件是封建时代且<code>GOAL-DEF-TRUCH</code>为1，即防御塔爆状态</p>
<ol>
<li>首先取消<code>GOAL-FAST-ATTACK</code>计划</li>
<li>如果发现有石矿，造采石场</li>
<li><p>如果能造塔，并且已造塔数小于4，那么就造塔<br> 注意下面的造塔命令，能够粗略地控制造塔范围</p>
 <figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">town-size </span><span class="string">12)</span></span><br><span class="line">(<span class="string">build </span><span class="string">watch-tower-</span><span class="string">line)</span></span><br><span class="line">(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">town-size </span><span class="string">20)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果每个敌人都没到城堡，如果能造塔，并且已造塔数小于8，那么反塔爆别人<br> 这里用了<code>build-forward</code>命令，即前置造建筑物。</p>
</li>
<li>当自己到了城堡之后，如果塔还没清掉（估计是石墙搞了一波农民搏不掉），那么就造BK（siege-workshop）。下面不用多说，造攻城车（<code>battering-ram-line</code>）。然后就等着攻城车自己清理吧。</li>
</ol>
<p>最后是防御塔爆的结束条件：</p>
<ol>
<li>城堡时代、农民数大于50</li>
<li>时间超过1020，塔全部被清理，农民数大于28</li>
</ol>
<p>前置塔攻就不详细讨论了，下面的是在成功防御前置塔攻之后的行为。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">game-time </span>&gt; <span class="string">900)</span></span><br><span class="line">	(<span class="string">goal </span><span class="string">GOAL-DEF-</span><span class="string">TRUCH </span>2)</span><br><span class="line">	(<span class="string">or </span>(<span class="string">goal </span><span class="string">GOAL-FORCE-</span><span class="string">COMPARE </span>3)</span><br><span class="line">		(<span class="string">goal </span><span class="string">GOAL-FORCE-</span><span class="string">COMPARE </span>4))</span><br><span class="line">	(<span class="string">players-building-</span><span class="string">type-count </span><span class="string">any-human-</span><span class="string">enemy </span><span class="string">watch-tower </span>&lt;= 0)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="string">chat-to-</span><span class="string">player </span><span class="string">this-any-</span><span class="string">human-enemy </span><span class="string">"11"</span>)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">GOAL-DEF-</span><span class="string">TRUCH </span>0)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">GOAL-FAST-</span><span class="string">ATTACK </span>1)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">GOAL-SPECIAL-</span><span class="string">AID </span>2)</span><br><span class="line">	(<span class="string">disable-timer </span><span class="string">TIMER-SPECIAL-</span><span class="string">AID)</span></span><br><span class="line">	(<span class="string">disable-self)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h3 id="防守TC暴"><a href="#防守TC暴" class="headerlink" title="防守TC暴"></a>防守TC暴</h3><p>TC暴（Douche）是种比较恶心的塔爆，玩家在黑暗自爆自己的TC，然后农民跑到对家的基地附近建TC，然后TC对射和对方耗。BOOM II对TC暴有着绝妙的应对方法，那就是不打TC暴、、、<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">game-time</span> &lt; <span class="number">900</span>)</span><br><span class="line">	(<span class="name">goal</span> GOAL-PVP <span class="number">1</span>)</span><br><span class="line">	(<span class="name">current-age</span> &lt;= feudal-age)</span><br><span class="line">	(<span class="name">cc-players-unit-type-count</span> any-human-enemy town-center &lt;= <span class="number">0</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">chat-to-player</span> this-any-human-enemy <span class="string">"不会吧？TC暴？"</span>)</span><br><span class="line">	(<span class="name">set-goal</span> GOAL-DEF-TRUCH <span class="number">3</span>)</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>cc-players-unit-type-count</code>是一个作弊命令，相对于不加<code>cc-</code>的命令，它获取玩家某一种类建筑的数目，不管自己能不能看到。这里判断如果在黑暗时代TC的数量变成0，那么对方很可能就是TC爆了。<br>将<code>GOAL-DEF-TRUCH</code>改成3表示当前是TC爆。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">goal</span> GOAL-DEF-TRUCH <span class="number">3</span>)</span><br><span class="line">	(<span class="name">goal</span> GOAL-TOWN-SIZE-ATTACK <span class="number">0</span>)</span><br><span class="line">	(<span class="name">enemy-buildings-in-town</span>)</span><br><span class="line">	(<span class="name">town-under-attack</span>)</span><br><span class="line">	(<span class="name">players-building-type-count</span> any-human-enemy town-center &gt;= <span class="number">1</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">chat-to-all</span> <span class="string">"不打TC暴！"</span>)</span><br><span class="line">	(<span class="name">set-goal</span> GOAL-RESIGN <span class="number">1</span>)</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h2 id="城快进攻"><a href="#城快进攻" class="headerlink" title="城快进攻"></a>城快进攻</h2><h1 id="UserPatch-v1-4简介"><a href="#UserPatch-v1-4简介" class="headerlink" title="UserPatch v1.4简介"></a>UserPatch v1.4简介</h1><p>我们发现帝国时代内置的ai命令还是比较弱的，我们很难实现一些逻辑。简单地说，删除所有闲置的农民就难以实现。为此使用UserPatch提供的增强版Scripting是个不错的选择。</p>
<h2 id="UP的安装"><a href="#UP的安装" class="headerlink" title="UP的安装"></a>UP的安装</h2><p>在网站userpatch.aiscripters.net上下载，里面包含一个Reference文件夹和一个exe程序。<br>Reference里面Scripting文件夹里面的per文件是需要load进去的常量，另一个Reference.html与网上在线的<a href="http://userpatch.aiscripters.net/reference.html" target="_blank" rel="noopener">Guide</a>相同。<br>此外，网站的<a href="http://forums.aiscripters.com" target="_blank" rel="noopener">论坛</a>也能提供更详细的资料。</p>
<h2 id="UP基础语法"><a href="#UP基础语法" class="headerlink" title="UP基础语法"></a>UP基础语法</h2><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>在Native DSL中goal的值既不能直接拿出来，也不能直接比较，UP改善了这个特性。<br>首先引入了三个类型运算符<code>c:</code>、<code>g:</code>、<code>s:</code>。<code>c:</code>表示作为常数值，<code>g:</code>表示作为goal值，<code>s:</code>表示作为sn值。<br>举一个例子<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defconst</span> gl-slot0 <span class="number">100</span>)</span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">set-goal</span> gl-slot0 <span class="number">77</span>)</span><br><span class="line">	(<span class="name">up-chat-data-to-all</span> <span class="string">"gl-slot0 key is: %d"</span> c: gl-slot0)</span><br><span class="line">	(<span class="name">up-chat-data-to-all</span> <span class="string">"gl-slot0 value is: %d"</span> g: gl-slot0)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>以上rule的结果是</p>
<pre><code>gl-slot0 key is: 100
gl-slot0 value is: 77
</code></pre><p>可以发现现在goal可以真正地作为变量使用了，在定义变量的时候，我们通常以<code>gl-</code>为前缀，这样的<code>gl-</code>类似于一个整型指针（只不过由我们自己规定地址），<code>g:</code>可以将它解引用。<br>但是注意不能在<code>set-goal</code>里面用<code>g:</code><br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">set-goal</span> <span class="string">gl-slot1 </span>g: <span class="string">sl-slot0)</span></span><br></pre></td></tr></table></figure></p>
<p>替代方案是使用<code>up-modify-goal</code>。</p>
<h3 id="get系列函数"><a href="#get系列函数" class="headerlink" title="get系列函数"></a>get系列函数</h3><p>既然goal可以作为变量使用，那么我们肯定希望用它来保存一下有用数据，<code>up-get-</code>系列函数能够将我们需要的一些数据取到变量中。</p>
<h4 id="get-fact系列"><a href="#get-fact系列" class="headerlink" title="get fact系列"></a>get fact系列</h4><p><code>up-get-fact</code>是最基础的get fact函数。<br>在先前，我们不能获取<code>military-population</code>的值，我们只能拿它进行比较，如<code>(military-population &gt; 10)</code>。<br>但现在我们可以将它保存在<code>gl-data</code>中了。遗憾的是似乎这个函数只能获取UserPatchConst中定义的fact，另外的一些，例如<code>villager-hunter</code>之类的就没办法获取。<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(defconst gl-data <span class="number">101</span>)</span><br><span class="line">(defconst military-population <span class="number">31</span>)</span><br><span class="line">(defrule</span><br><span class="line">	(<span class="built_in">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(up-get-<span class="built_in">fact</span> military-population <span class="number">0</span> gl-data)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>但是UP还可以为我们做更多，我们可以获得某些玩家（由every/any通配符指定）事实集合中的最大/小值以及和，如<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defconst</span> gl-my-civ-sum <span class="number">101</span>)</span><br><span class="line">(<span class="name">defconst</span> gl-ene-civ-sum <span class="number">102</span>)</span><br><span class="line">(<span class="name">defconst</span> gl-cmp <span class="number">103</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name">defconst</span> civilian-population <span class="number">32</span>)	<span class="comment">;any</span></span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-get-fact-sum</span> any-enemy civilian-population <span class="number">0</span> gl-ene-civ-sum)</span><br><span class="line">	(<span class="name">up-get-fact</span> civilian-population <span class="number">0</span> gl-my-civ-sum)</span><br><span class="line">	(<span class="name">up-modify-goal</span> gl-cmp g<span class="symbol">:=</span> gl-my-civ-sum)</span><br><span class="line">	(<span class="name">up-modify-goal</span> gl-cmp g<span class="symbol">:/</span> gl-ene-civ-sum)</span><br><span class="line">	(<span class="name">up-chat-data-to-all</span> <span class="string">"me is: %d"</span> g: gl-my-civ-sum)</span><br><span class="line">	(<span class="name">up-chat-data-to-all</span> <span class="string">"ene is: %d"</span> g: gl-ene-civ-sum)</span><br><span class="line">	(<span class="name">up-chat-data-to-all</span> <span class="string">"comparation of ene and me is: %d"</span> g: gl-cmp)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>这个可以输出敌人的农民人口与自己的农民人口的比值，可惜是整数，这里因为我们没有探测到敌人的家，所以<code>gl-ene-civ-sum</code>值是0或-1，结果是0。</p>
<h3 id="成本函数"><a href="#成本函数" class="headerlink" title="成本函数"></a>成本函数</h3><p><code>up-reset-cost-data</code>将四种资源成本全部置零，例如<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defconst</span> gl-military-cost-food <span class="number">111</span>)</span><br><span class="line">(<span class="name">defconst</span> gl-military-cost-wood <span class="number">112</span>)</span><br><span class="line">(<span class="name">defconst</span> gl-military-cost-stone <span class="number">113</span>)</span><br><span class="line">(<span class="name">defconst</span> gl-military-cost-gold <span class="number">114</span>)</span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-setup-cost-data</span> <span class="number">1</span> gl-military-cost-food)	</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>当第一个参数为1的时候，将所有的成本设置为0，真是够奇葩的，为啥不搞个memset一样的呢？<br>为什么第二个参数是<code>gl-military-cost-food</code>呢？因为可以把<code>gl-military-cost-food</code>到<code>gl-military-cost-gold</code>看成一个四个元素的数组，而<code>gl-military-cost-food</code>相当于传入了一个头指针。<br>在使用<code>up-reset-cost-data</code>，其他的成本函数都是对当前选定的“数组”进行操作了。<br>下面的代码往总成本上加了两份军事成本（每份成本包含一个骑士）<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(defrule</span><br><span class="line">	(true)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="keyword">up</span>-setup-cost-data <span class="number">1</span> gl-military-cost-food)</span><br><span class="line">	(<span class="keyword">up</span>-<span class="built_in">add</span>-object-cost <span class="keyword">c</span>: knight-<span class="built_in">line</span> <span class="keyword">c</span>: <span class="number">1</span>)</span><br><span class="line">	(<span class="keyword">up</span>-setup-cost-data <span class="number">1</span> gl-cost-food)</span><br><span class="line">	(<span class="keyword">up</span>-<span class="built_in">add</span>-cost-data gl-military-cost-food <span class="keyword">c</span>: <span class="number">2</span>)</span><br><span class="line">	</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"wood is: %d"</span> <span class="variable">g:</span> gl-cost-wood)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"stone is: %d"</span> <span class="variable">g:</span> gl-cost-stone)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"food is: %d"</span> <span class="variable">g:</span> gl-cost-food)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"gold is: %d"</span> <span class="variable">g:</span> gl-cost-gold)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"mit wood is: %d"</span> <span class="variable">g:</span> gl-military-cost-wood)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"mit stone is: %d"</span> <span class="variable">g:</span> gl-military-cost-stone)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"mit food is: %d"</span> <span class="variable">g:</span> gl-military-cost-food)</span><br><span class="line">	(<span class="keyword">up</span>-chat-data-<span class="keyword">to</span>-<span class="keyword">all</span> <span class="string">"mit gold is: %d"</span> <span class="variable">g:</span> gl-military-cost-gold)</span><br><span class="line">	(disable-self)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>up-add-object-cost</code>第一个参数表示单位id，第二个参数表示数量，相对<code>up-setup-cost-data</code>还有科技研发成本<code>up-add-research-cost</code><br><code>up-setup-cost-data</code>第一个参数表示一个goal，第二个参数表示份数<br><code>up-get-cost-delta</code>计算当前资源与建造成本的差值，负的表示不够。这个值与escrow无关。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-setup-cost-data</span> <span class="number">1</span> gl-cost-food)	</span><br><span class="line">	<span class="comment">;(up-modify-escrow wood c:= 100)</span></span><br><span class="line">	(<span class="name">up-add-object-cost</span> c: archer-line c: <span class="number">200</span>)</span><br><span class="line">	(<span class="name">up-get-cost-delta</span> gl-delta-food)</span><br><span class="line">	(<span class="name">up-chat-data-to-all</span> <span class="string">"delta is: %d"</span> g: gl-delta-wood)</span><br><span class="line">	(<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h2 id="坐标代数"><a href="#坐标代数" class="headerlink" title="坐标代数"></a>坐标代数</h2><p>UP提供的坐标代数能实现高级AI的精细控制，如<a href="http://www.hawkaoc.net/bbs/forum.php?mod=viewthread&amp;tid=118721" target="_blank" rel="noopener">此篇帖子</a>。<br>为了表示坐标，首先定义一个点对。类似于上面<code>up-reset-cost-data</code>操纵资源的方式，点对的地址应当是连续的（形成一个二维数组），如下面的100和101，这样<code>gl-point-x</code>可以看做指向该点对的指针。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defconst</span> gl-point-x <span class="number">100</span>)</span><br><span class="line">(<span class="name">defconst</span> gl-point-y <span class="number">101</span>)</span><br></pre></td></tr></table></figure></p>
<p>我们可以将<code>gl-point-x</code>点对设为目标点，供如<code>up-build</code>等命令使用<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(up-<span class="built_in">set</span>-target-<span class="built_in">point</span> gl-<span class="built_in">point</span>-x)</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p><code>up-lerp-percent</code>和<code>up-lerp-tiles</code><br>这个用来计算坐标偏移，将第一个点对作为基点，第二个点对作为位移值进行偏移。<br><code>up-lerp-tiles</code>会偏移固定的格数，<code>up-lerp-precent</code>则按百分比。</p>
</li>
<li><p><code>up-cross-tiles</code><br>我写了段<a href="http://paste.ubuntu.com/25719285/" target="_blank" rel="noopener">代码测试了一下</a>，并没有看出来有啥用，应该结果保存在第一个点</p>
</li>
</ol>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>在同一个文件里面rules的执行可以看成是从上至下的，因此可以利用<code>up-jump-rule</code>来实现选择或者循环结构，但注意<code>#load</code>块可能影响位置。</p>
<h2 id="直接寻的系统"><a href="#直接寻的系统" class="headerlink" title="直接寻的系统"></a>直接寻的系统</h2><h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p>过滤器由<code>up-filter-distance</code>、<code>up-filter-exclude</code>、<code>up-filter-garrison</code>、<code>up-filter-include</code>、<code>up-filter-range</code>构成<br>注意以下命令中-1表示忽略此过滤条件</p>
<ol>
<li>选择目标点周围10个内单位：<code>(up-filter-distance c: -1 c: 10)</code>，其中两个参数分别为最小距离和最大距离</li>
<li>派出具有某个编号的单位：<code>(up-filter-exclude cmdid-trade -1 -1 -1)</code>，其中四个参数分别表示命令编号、行动编号、执行编号和类别编号。例如<code>(up-filter-exclude -1 actionid-explore orderid-relic warship-class)</code></li>
<li>选择驻扎了至少5个单位的建筑：<code>(up-filter-garrison c: 5 c: -1)</code>，两个参数同样是最大值和最小值</li>
<li><code>up-filter-include</code>这个和exclude是相似的，不过第四个参数改为了是否在主大陆上</li>
</ol>
<p>一般重置需要同时重置search结果和过滤器，即<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">up-reset-search</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span>)</span><br><span class="line">(<span class="name">up-reset-filters</span>)</span><br></pre></td></tr></table></figure></p>
<p>使用直接寻的系统找到的对象可以利用<code>up-set-target-object</code>设为目标，然后通过<code>up-object-data</code>等语句对目标进行操作，下面的语句摘自拉猪部分<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(up-<span class="keyword">set</span>-target-<span class="keyword">object</span> <span class="keyword">search</span>-<span class="keyword">local</span> c: <span class="number">0</span>)</span><br><span class="line">(up-<span class="keyword">object</span>-<span class="keyword">data</span> <span class="keyword">object</span>-<span class="keyword">data</span>-hitpoints &lt; <span class="number">40</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="人员控制"><a href="#人员控制" class="headerlink" title="人员控制"></a>人员控制</h2><p>包括驻扎、巡逻、删除冗余人员</p>
<ol>
<li>驻扎<br><code>up-gather-inside</code>可以指定建筑生产集合点是自己本身。这在操作的时是很有用的一个特性，一方面敌人不容易观察你到底生产了什么，第二个单位不至于瞎跑，或者被泼粪车泼到。<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(defrule</span><br><span class="line">	(<span class="built_in">true</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(up-gather-inside <span class="symbol">c:</span> dock <span class="symbol">c:</span> <span class="number">1</span>)</span><br><span class="line">	(disable-self)</span><br><span class="line">)</span><br><span class="line">(defrule</span><br><span class="line">	(unit-<span class="built_in">type</span>-<span class="built_in">count</span> warship-class &gt;= <span class="number">10</span>) ; warship-class = <span class="number">922</span></span><br><span class="line">=&gt;</span><br><span class="line">	(up-gather-inside <span class="symbol">c:</span> dock <span class="symbol">c:</span> <span class="number">0</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>直接驻扎的命令是<code>up-garrison</code>，如<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(up-garrison battering-ram c: infantry-<span class="class"><span class="keyword">class</span>) </span>; infantry-<span class="class"><span class="keyword">class</span> </span>= <span class="number">906</span></span><br></pre></td></tr></table></figure></p>
<p>将所有步兵驻扎到工程车中，注意指定建筑不能使用battering-ram-line这种带wildcard的。</p>
<ol start="2">
<li>up-guard-unit</li>
</ol>
<h1 id="UserPatch-AI赏析之Bruteforce"><a href="#UserPatch-AI赏析之Bruteforce" class="headerlink" title="UserPatch AI赏析之Bruteforce"></a>UserPatch AI赏析之Bruteforce</h1><p>Bruteforce是一个适合新手练习的AI。</p>
<h2 id="AI概览"><a href="#AI概览" class="headerlink" title="AI概览"></a>AI概览</h2><p>AI预定义了定义了一些城堡时代的打法，有些英文属于可以查询<a href="http://www.hawkaoc.net/bbs/thread-135806-1-1.html" target="_blank" rel="noopener">网站</a>，对应着各个per文件。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defconst</span> sn-castle-age-strategy <span class="number">182</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name">defconst</span> xbow <span class="number">1</span>)</span><br><span class="line">(<span class="name">defconst</span> end-game <span class="number">2</span>)</span><br><span class="line">(<span class="name">defconst</span> krush <span class="number">3</span>)</span><br><span class="line">(<span class="name">defconst</span> EAGLE-RUSH <span class="number">4</span>)</span><br><span class="line">(<span class="name">defconst</span> fast-castle <span class="number">5</span>)</span><br><span class="line">(<span class="name">defconst</span> eagle-rush <span class="number">6</span>)</span><br><span class="line">(<span class="name">defconst</span> conquistadors <span class="number">7</span>)</span><br><span class="line">(<span class="name">defconst</span> naval-fun <span class="number">8</span>)</span><br><span class="line">(<span class="name">defconst</span> klew <span class="number">9</span>)</span><br><span class="line">(<span class="name">defconst</span> castled <span class="number">10</span>)</span><br><span class="line">(<span class="name">defconst</span> booming <span class="number">11</span>)</span><br><span class="line">(<span class="name">defconst</span> lsr <span class="number">12</span>)</span><br><span class="line">(<span class="name">defconst</span> PIKEMAN <span class="number">13</span>)</span><br><span class="line">(<span class="name">defconst</span> DRUSH <span class="number">14</span>)</span><br><span class="line">(<span class="name">defconst</span> RUN <span class="number">15</span>) <span class="comment">; https://youtu.be/mw2kKyJu9gY?t=2m11s</span></span><br></pre></td></tr></table></figure></p>
<p>end-game应该表示此战术已失效<br>xbow是打弩手。<br>Krush指的是城快马爆，28p升封建。<br>Scrush是打肉马（配合弩手和散兵），24p到封建。<br>Skirm是打散兵（掷矛战士），24p到封建。<br>GenericAra是通用阿拉伯，以打弓箭为主，23-24p升封建。<br>KLEW(Kidd’s Lightning Eagle Warrior Rush)是美洲民族的打法，主张直城，然后雄鹰快攻，24p到封建，卖石头点城堡。<br>Booming是暴经济直帝，30p到封建<br>PIKEMAN是长枪兵。<br>TRASH是垃圾兵（长戟和掷矛）。<br>MAA是打装甲步兵。<br>HCA是打骑射手。<br>Sling是打进贡。<br>CASTLED(Castle Drop)是打前置城堡。</p>
<h2 id="开局"><a href="#开局" class="headerlink" title="开局"></a>开局</h2><p>现在选择我最喜欢的蒙古民族，在阿拉伯地图上进行开局。<br>我们看到蒙古民族会随机加载一些策略文件。<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#load-<span class="meta-keyword">if</span>-defined MONGOL-CIV</span></span><br><span class="line"><span class="meta">#load-<span class="meta-keyword">if</span>-defined UP-POCKET-POSITION</span></span><br><span class="line">(<span class="built_in">load</span> <span class="string">"Brutal2\Krush"</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">(<span class="built_in">load</span>-<span class="built_in">random</span> <span class="number">45</span> <span class="string">"Brutal2\GenericAra"</span></span><br><span class="line">			 <span class="number">52</span> <span class="string">"Brutal2\Scrush"</span></span><br><span class="line">             <span class="number">3</span> <span class="string">"Brutal2\Krush"</span>)</span><br><span class="line"><span class="meta">#end-<span class="meta-keyword">if</span></span></span><br><span class="line"><span class="meta">#end-<span class="meta-keyword">if</span></span></span><br></pre></td></tr></table></figure></p>
<p><code>UP-POCKET-POSITION</code>指的是玩家是否坐中，那1v1的时候玩家始终坐中，于是就用马爆策略。</p>
<h3 id="造房子"><a href="#造房子" class="headerlink" title="造房子"></a>造房子</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#load-if-not-defined CHINESE-CIV</span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">up-gaia-type-count</span> c: livestock-class == <span class="number">0</span>)</span><br><span class="line">	(<span class="name">building-type-count-total</span> town-center &gt;= <span class="number">1</span>)</span><br><span class="line">	(<span class="name">population-headroom</span> &gt; <span class="number">0</span>)</span><br><span class="line">	(<span class="name">housing-headroom</span> &lt; <span class="number">3</span>)</span><br><span class="line">	(<span class="name">up-pending-objects</span> c: house &lt; <span class="number">1</span>)</span><br><span class="line">	(<span class="name">building-type-count-total</span> house &lt; <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-can-build</span> <span class="number">0</span> c: house)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-assign-builders</span> c: house c: <span class="number">2</span>)</span><br><span class="line">	(<span class="name">set-strategic-number</span> sn-placement-zone-size <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-set-placement-data</span> my-player-number villager c: <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-build</span> place-control <span class="number">0</span> c: house)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>up-gaia-type-count</code>用来表示尚存的的自然资源的数目，例如<code>(up-gaia-type-count c: livestock-class &gt; 6)</code>表示是否还存在超过6只绵羊或火鸡。与之对应的是<code>up-gaia-type-count-total</code>，表示所有曾经发现过的自然资源的数目，但是对鹿和羊来说没有相关数据，所以其实返回的是<code>up-gaia-type-count</code>的结果。注意，看到的羊可能还是灰色，并不等于自己拥有的羊。看自己的羊应该用<code>up-object-type-count</code>，并且羊被杀了之后<code>up-object-type-count</code>会减少，而不是吃完会减少。<br><code>population-headroom</code>指的是游戏设置最大人口和目前住房提供人口的差额。<br><code>housing-headroom</code>指的是目前住房提供人口和实际人口的差额。<br>上面这段是造第一个房子，由于中国城镇中心提供10个人口，所以中国不需要造第一个房子。<br><code>up-assign-builders</code>为指定类型建筑分配农民数，由于一开始就只有一个人口富余，容易卡房子，所以分配两个农民造。<br>有意思的是<code>up-build</code>命令，它的第二个参数可以取<code>place-normal</code>、<code>place-forward</code>、<code>place-control</code>、<code>place-point</code>。<br>这里的<code>place-control</code>是与<code>up-set-placement-data</code>配合使用的。例如<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(up-<span class="keyword">set</span>-placement-<span class="keyword">data</span> my-player-<span class="built_in">number</span> <span class="number">-1</span> c: <span class="number">-25</span>) ; home town center = -1</span><br></pre></td></tr></table></figure></p>
<p>表示在主TC后面25格。本段代码的意思即在村民旁边建造房子。<br>而<code>place-point</code>则是利用<code>up-set-target-point</code>储存的地点。<br><code>sn-placement-zone-size</code>在<code>place-forward</code>、<code>place-control</code>这两个选项时。<br>下面是另外一个造房子的条件，在开局的时候并没有被触发。由于这两个行为是全部一样的，所以其实我感觉做简单一点，这两个可以合为一个。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">game-time</span> &lt; <span class="number">7</span>)</span><br><span class="line">	(<span class="name">up-gaia-type-count</span> c: livestock-class &gt; <span class="number">0</span>)</span><br><span class="line">	(<span class="name">building-type-count</span> house &lt; <span class="number">1</span>)</span><br><span class="line">	(<span class="name">building-type-count-total</span> town-center &gt;= <span class="number">1</span>)</span><br><span class="line">	(<span class="name">population-headroom</span> &gt; <span class="number">0</span>)</span><br><span class="line">	(<span class="name">housing-headroom</span> &lt; <span class="number">3</span>)</span><br><span class="line">	(<span class="name">up-pending-objects</span> c: house &lt; <span class="number">2</span>)</span><br><span class="line">	(<span class="name">up-can-build</span> <span class="number">0</span> c: house)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-assign-builders</span> c: house c: <span class="number">2</span>)</span><br><span class="line">	(<span class="name">set-strategic-number</span> sn-placement-zone-size <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-set-placement-data</span> my-player-number villager c: <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-build</span> place-control <span class="number">0</span> c: house)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>如果房子超过一个了，开局就不会卡农民了，这样将造房子的农民减少到一个。<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(defrule</span><br><span class="line">	(building-<span class="built_in">type</span>-<span class="built_in">count</span> house &gt; <span class="number">0</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(up-assign-builders <span class="symbol">c:</span> house <span class="symbol">c:</span> <span class="number">1</span>)</span><br><span class="line">	(disable-self)</span><br><span class="line">)</span><br><span class="line">#end-<span class="built_in">if</span></span><br></pre></td></tr></table></figure></p>
<p>注意开局的时候我们一般是造两个房子，一个分配2农民，一个分配1农民，这样会导致超过<code>sn-cap-civilian-builders</code>的默认值2，所以最好在一开始扩大一下，例如设为25。最重要的是<code>sn-enable-new-building-system</code>必须设为1，否则村民只能同时建造一个建筑。</p>
<h3 id="农民调配"><a href="#农民调配" class="headerlink" title="农民调配"></a>农民调配</h3><p>可以结合<a href="http://hawkaoc.net/bbs/thread-118795-1-1.html" target="_blank" rel="noopener">这篇帖子</a>和<a href="http://www.hawkaoc.net/bbs/forum.php?mod=viewthread&amp;tid=30435" target="_blank" rel="noopener">这篇帖子</a>来理解AI的一些思路。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">up-compare-</span><span class="string">goal </span><span class="string">gl-map-</span><span class="string">style </span>!= <span class="string">LAND-NOMAD)</span></span><br><span class="line">	(<span class="string">up-compare-</span><span class="string">goal </span><span class="string">gl-map-</span><span class="string">style </span>!= <span class="string">NOMAD)</span></span><br><span class="line">	(<span class="string">current-age </span>== <span class="string">dark-age)</span></span><br><span class="line">	(<span class="string">game-time </span>&lt; <span class="string">civilian-exploration-</span><span class="string">time)</span></span><br><span class="line">	(<span class="string">unit-type-</span><span class="string">count </span><span class="string">livestock-class </span>&lt; 1)</span><br><span class="line">	(<span class="string">strategic-number </span><span class="string">sn-number-</span><span class="string">explore-groups </span>!= 4)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-cap-</span><span class="string">civilian-explorers </span><span class="string">civ-explorers)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-cap-</span><span class="string">civilian-gatherers </span><span class="string">100)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">civilian-gatherers </span><span class="string">100)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">civilian-explorers </span><span class="string">100)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-number-</span><span class="string">explore-groups </span><span class="string">civ-explorers)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-total-</span><span class="string">number-explorers </span><span class="string">civ-explorers)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>以上部分是早期探索阶段，阿拉伯地图的<code>civilian-exploration-time</code>为60。根据调试，实际上更多运行的是下面这个rule，因为通常农民很快就能找到一个羊群。这时候设置农民探索者最大数量为0，采集者最大数量为100，并且所有的农民都去采集。探索者的队伍容量为1人。<br>这里注意与<code>sn-number-explore-groups</code>和<code>sn-total-number-explorers</code>区别，前者指的是陆地上的探索者数量，后者指的是村民探索者和军队探索者的总和。但是当有军队进行探索的时候似乎不会派村民进行较多的侦查活动。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">up-compare-</span><span class="string">goal </span><span class="string">gl-map-</span><span class="string">style </span>!= <span class="string">LAND-NOMAD)</span></span><br><span class="line">	(<span class="string">up-compare-</span><span class="string">goal </span><span class="string">gl-map-</span><span class="string">style </span>!= <span class="string">NOMAD)</span></span><br><span class="line">	(<span class="string">building-type-</span><span class="string">count </span><span class="string">town-center </span>&gt; 0)</span><br><span class="line">	(<span class="string">current-age </span>== <span class="string">dark-age)</span></span><br><span class="line">	(<span class="string">or(</span><span class="string">game-time </span>&gt; <span class="string">civilian-exploration-</span><span class="string">time)</span></span><br><span class="line">	(<span class="string">or(</span><span class="string">building-type-</span><span class="string">count-total </span><span class="string">mill </span>&gt; 0)</span><br><span class="line">	   (<span class="string">unit-type-</span><span class="string">count </span><span class="string">livestock-class </span>&gt;= 2)))	  </span><br><span class="line">	(<span class="string">strategic-number </span><span class="string">sn-number-</span><span class="string">explore-groups </span>!= 4)	   </span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-cap-</span><span class="string">civilian-explorers </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-cap-</span><span class="string">civilian-gatherers </span><span class="string">100)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">civilian-explorers </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">civilian-gatherers </span><span class="string">100)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-number-</span><span class="string">explore-groups </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-total-</span><span class="string">number-explorers </span>1)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>再往后，根据战术的不同，资源调配的方案有很大不同。</p>
<h3 id="sn设置"><a href="#sn设置" class="headerlink" title="sn设置"></a>sn设置</h3><p>下面是strategy number设置，这里分了几部分是因为rule里面action的条数限制<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">true)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-cap-</span><span class="string">civilian-builders </span><span class="string">25)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-livestock-</span><span class="string">to-town-</span><span class="string">center </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enable-</span><span class="string">new-building-</span><span class="string">system </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enable-</span><span class="string">training-queue </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-allow-</span><span class="string">adjacent-dropsites </span>1)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-dropsite-</span><span class="string">separation-distance </span>5)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-disable-</span><span class="string">builder-assistance	</span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-camp-</span><span class="string">max-distance </span><span class="string">16)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-mill-</span><span class="string">max-distance </span><span class="string">32)</span></span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-defer-</span><span class="string">dropsite-update </span>1)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-task-</span><span class="string">ungrouped-soldiers </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enable-</span><span class="string">patrol-attack </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">hunt-drop-</span><span class="string">distance </span><span class="string">12)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">town-size </span><span class="string">10)</span></span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">gl-new-</span><span class="string">town-size </span><span class="string">10)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-max-</span><span class="string">retask-gather-</span><span class="string">amount </span><span class="string">10)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-retask-</span><span class="string">gather-amount </span>0)</span><br><span class="line">	(<span class="string">disable-self)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>sn-camp-max-distance</code>表示伐木场和矿场和城镇中心最远的距离，不可能说我们的一个伐木放到敌人家门口的，对应有<code>sn-mill-max-distance</code>。BF将这两个值分别设为16和32<br><code>sn-defer-dropsite-update</code>策略，设为1的时候当新资源放置点建好时才更新<code>dropsite-min-distance</code>，否则刚建造就更新。<br><code>sn-task-ungrouped-soldiers</code>策略在TSA攻击时比较有用，它设定未编组部队是否分散开并保卫城镇地区。如果说是1，那么非编组军队（可以认为是空闲的军队）就会在城镇范围内散开并“游荡”。<br><code>sn-enable-patrol-attack</code>为巡逻式攻击命令，可参见<a href="http://aok.heavengames.com/cgi-bin/forums/display.cgi?action=ct&amp;f=28,40999,,30" target="_blank" rel="noopener">heavengames上的说明</a><br><code>sn-allow-adjacent-dropsites</code>指的是否将资源放置点建到紧贴资源，这里选择的是1，但是我觉得0更好，这样资源放置点与资源之间会有一格距离，农民和资源放置点之间的接触面会更大<br><code>sn-enable-training-queue</code>允许在训练队列中pending一个单位。我们实际操作的时候可能喜欢按shift，然后一下子让电脑造5个甚至填满训练队列，这样会预先一次性支出所有单位的训练资源，但好处是防止我们操作不过来延误暴兵。但是电脑没有这方面的烦恼，rule的触发条件满足了，就会造单位，所以没必要把训练队列里面塞满。由于计算机对所有rule的一趟遍历是周期性的，所以这个命令使得，例如前期一个农民造好后能够立刻开始造下一个农民，而不是可能会等1-2秒。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">true)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-intelligent-</span><span class="string">gathering </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-use-</span><span class="string">by-type-</span><span class="string">max-gathering </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-gather-</span><span class="string">defense-units </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-military-</span><span class="string">level </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enemy-</span><span class="string">sighted-response-</span><span class="string">distance </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">enemy-sighted-</span><span class="string">response </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">attack-soldiers </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enemy-</span><span class="string">current-age </span><span class="string">dark)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-dropsite-</span><span class="string">separation-distance </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-local-</span><span class="string">targeting-mode </span>1)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-ttkfactor-</span><span class="string">scalar </span><span class="string">200)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">building-cancellation </span><span class="string">10)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-zero-</span><span class="string">priority-distance </span><span class="string">250)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-initial-</span><span class="string">exploration-required </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enemy-</span><span class="string">sling-target-</span><span class="string">player </span>0)</span><br><span class="line">	(<span class="string">disable-self)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>sn-intelligent-gathering</code>是智能采集系统，有什么用呢？从<a href="http://forums.aiscripters.com/viewtopic.php?f=8&amp;t=2558&amp;p=44944&amp;hilit=sn+intelligent+gathering#p44944" target="_blank" rel="noopener">论坛</a>上有</p>
<blockquote>
<p>If you do up-retask-gatherers without sn-intelligent-gathering on, then the villagers will lose their load. If you do it with sn-intelligent-gathering then you don’t lose the load.</p>
</blockquote>
<p><code>sn-military-level</code>并没有在UP或者原生DSL中出现，从<a href="https://gist.github.com/Andygmb/1e3a6d9d444b2dfa8c40" target="_blank" rel="noopener">gist上的这份源码</a>，应该是自己的军事力量越强，<code>sn-military-level</code>就被设得越高<br><code>sn-initial-exploration-required</code>是修建建筑前最少的探索地图比例，由于农民直接在身后拍房子，所以应当为0。注意它的默认值不是0！所以一定要显式地修改回0。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">true)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-percent-</span><span class="string">attack-soldiers </span><span class="string">100)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">attack-group-</span><span class="string">size </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-preferred-</span><span class="string">trade-distance </span><span class="string">255)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-consecutive-</span><span class="string">idle-unit-</span><span class="string">limit </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-attack-</span><span class="string">winning-player </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-attack-</span><span class="string">winning-player-</span><span class="string">factor </span>0)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-placement-</span><span class="string">fail-delta </span>1)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-placement-</span><span class="string">to-center </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-blot-</span><span class="string">exploration-map </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-blot-</span><span class="string">size </span><span class="string">blot-size)</span></span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-escrow-</span><span class="string">level </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-allow-</span><span class="string">direct-unit-</span><span class="string">control </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-maximum-</span><span class="string">fish-boat-</span><span class="string">drop-distance </span>5)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">gl-slain-</span><span class="string">deer </span>0)</span><br><span class="line">	(<span class="string">up-setup-</span><span class="string">cost-data </span>1 <span class="string">gl-cost-</span><span class="string">food)</span></span><br><span class="line">	(<span class="string">disable-self)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>sn-preferred-trade-distance</code>偏好贸易距离，由于贸易越长越好，所以设为255.</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">true)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-archer-</span><span class="string">threat </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-infantry-</span><span class="string">threat </span>0)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-cavalry-</span><span class="string">threat </span>0)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-disable-</span><span class="string">trade-evasion </span>1)</span><br><span class="line">	;(<span class="built_in">set-strategic-number</span> <span class="string">sn-disable-</span><span class="string">villager-garrison </span>1) ; 2 <span class="string">affects </span><span class="string">towers </span><span class="string">too</span></span><br><span class="line"><span class="string">	</span>;(<span class="built_in">set-strategic-number</span> <span class="string">sn-target-</span><span class="string">point-adjustment </span>3) ; <span class="string">right</span></span><br><span class="line"><span class="string">	</span>(<span class="built_in">set-strategic-number</span> <span class="string">sn-allow-</span><span class="string">drush-defense </span>0)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">temporary-goal12 </span>1) ; <span class="string">player </span>1 <span class="string">as </span><span class="string">default.</span></span><br><span class="line">	(<span class="string">up-change-</span><span class="string">name </span><span class="string">"BruteForce"</span>) ; <span class="string">Make </span><span class="string">it </span><span class="string">easier </span><span class="string">for </span>1.5</span><br><span class="line">	(<span class="string">disable-self)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>其中<code>LAND-NOMAD</code>为陆游，<code>NOMAD</code>为游牧。<br>下面这段造农民的代码来自Krush部分。<br>我们实际上看到在主per文件里面也有相应的造农民代码，但这个是互相不冲突的，因为条件写得很严格。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">up-compare-goal</span> gl-map-style != WATER) </span><br><span class="line">	(<span class="name">strategic-number</span> sn-castle-age-strategy == krush)</span><br><span class="line">	(<span class="name">unit-type-count-total</span> villager &lt; max-civ)</span><br><span class="line">	(<span class="name">up-research-status</span> c: ri-loom &lt; research-pending)</span><br><span class="line">	(<span class="name">unit-type-count</span> villager &lt; <span class="number">10</span>)</span><br><span class="line">	(<span class="name">can-train</span> villager)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">train</span> villager)</span><br><span class="line">	(<span class="name">enable-timer</span> <span class="number">46</span> <span class="number">21</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h3 id="牵羊"><a href="#牵羊" class="headerlink" title="牵羊"></a>牵羊</h3><p>小马斥候有时候可能看到羊，但不会多走几步取得这头羊控制权，并将其派回TC，因此需要进行牵羊。</p>
<h3 id="放伐木场、磨坊"><a href="#放伐木场、磨坊" class="headerlink" title="放伐木场、磨坊"></a>放伐木场、磨坊</h3><p>伐木一般要晚于磨坊。虽然农民一般先狩猎，但当羊比较难找时草料丛就起作用了，还有一点是为了种田的方便，最好让农民先把TC旁边的树木全部伐倒。<br><code>resource-found</code>语句中<code>food</code>参数特指草料丛，<code>wood</code>参数特指树林（而不是单棵的树）。但有时候（如存档aitest_farwood）即使找到了森林，伐木场依然可能建在单棵树的旁边，解决方案可以是延缓伐木场的建造时间，例如在第一个房子建成后。注意这条命令是一次性的，即使后面树木全部被挖完了，也依然是ture。如何检测是否还有树呢？可以使用下面的命令，如<code>dropsite-min-distance wood &lt; 255</code><br>在修建完伐木场后，可以检查<code>dropsite-min-distance</code>，<code>dropsite-min-distance</code>是个fact，用来检测从资源点到资源放置点的最少距离。如果说这个值比较大，那么我们的伐木场的效率就不算很高。</p>
<p>为什么农民建完伐木场不呆在伐木场旁边采木头，而是回去牧羊了呢？<br>这时候可以利用<code>up-target-objects</code>命令，强制农民走到伐木场处<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Task villagers to lumber-camp</span></span><br><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">current-age</span> == dark-age)</span><br><span class="line">	(<span class="name">building-type-count</span> lumber-camp &gt; <span class="number">0</span>)</span><br><span class="line">=&gt;</span><br><span class="line">   (<span class="name">up-reset-search</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span>)</span><br><span class="line">   (<span class="name">up-reset-filters</span>)</span><br><span class="line">   (<span class="name">up-find-local</span> c: villager-m-lumberjack c: <span class="number">240</span>)</span><br><span class="line">   (<span class="name">up-find-local</span> c: villager-f-lumberjack c: <span class="number">240</span>)</span><br><span class="line">   (<span class="name">up-modify-goal</span> temporary-goal s<span class="symbol">:=</span> sn-focus-player-number)</span><br><span class="line">   (<span class="name">up-modify-sn</span> sn-focus-player-number c<span class="symbol">:=</span> my-player-number)</span><br><span class="line">   (<span class="name">up-find-remote</span> c: lumber-camp c: <span class="number">1</span>)</span><br><span class="line">   (<span class="name">up-target-objects</span> <span class="number">0</span> action-default <span class="number">-1</span> <span class="number">-1</span>)</span><br><span class="line">   (<span class="name">up-modify-sn</span> sn-focus-player-number g<span class="symbol">:=</span> temporary-goal)</span><br><span class="line">   (<span class="name">chat-local-to-self</span> <span class="string">"task villagers to lumbercamp"</span>)</span><br><span class="line">   (<span class="name">disable-self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>up-target-objects</code>将被选择的<code>up-find-local</code>以普通模式<code>action-normal</code>（还可以选择<code>action-patrol</code>巡逻模式）指引到(direct against)<code>up-find-remote</code><br>除此之外，第三四个参数分别为阵型（formation-line, formation-box, formation-stagger, formation-flank）和动作（stance-aggressive, stance-defensive, stance-stand-ground, stance-no-attack）</p>
<p>BTW，我在搜<code>sn-intelligent-gathering</code>时意外的发现了<a href="http://forums.aiscripters.com/viewtopic.php?f=3&amp;t=2505&amp;p=49769&amp;hilit=sn+intelligent+gathering#p49769" target="_blank" rel="noopener">相反的问题</a></p>
<h3 id="拉猪"><a href="#拉猪" class="headerlink" title="拉猪"></a>拉猪</h3><p>这段代码来自于Bruteforce<br>电脑拉猪一般是用农民拉猪，升级织布机农民能够减少长距离拉猪农民死亡的可能性。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">up-research-status</span> c: ri-loom &gt;= research-pending)</span><br><span class="line">	(<span class="name"><span class="builtin-name">or</span></span>(<span class="name">unit-type-count-total</span> villager &gt;= <span class="number">11</span>)</span><br><span class="line">	   (<span class="name">game-time</span> &gt; <span class="number">275</span>))</span><br><span class="line">	(<span class="name">strategic-number</span> sn-enable-boar-hunting != <span class="number">2</span>)</span><br><span class="line">	(<span class="name">dropsite-min-distance</span> live-boar != <span class="number">-1</span>)</span><br><span class="line">	(<span class="name">dropsite-min-distance</span> live-boar s:&lt; sn-maximum-hunt-drop-distance)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">set-strategic-number</span> sn-enable-boar-hunting <span class="number">2</span>)</span><br><span class="line">	(<span class="name">set-strategic-number</span> sn-maximum-hunt-drop-distance <span class="number">32</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>sn-enable-boar-hunting</code>设为1是会杀鹿和猪，2则只杀猪。<br>首先当农民数大于等于11的时候，<strong>织布机升完了</strong>，此时如果猪距小于<code>sn-maximum-hunt-drop-distance</code>就设置<code>sn-enable-boar-hunting</code>为允许。注意特别判断值为-1，即未定义的情况，不然-1恒小于任何数会出错。<br>下面就开始拉第一头猪。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">strategic-number </span><span class="string">sn-enable-</span><span class="string">boar-hunting </span>== 2)</span><br><span class="line">	;(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">boar-hunting </span>&gt; <span class="string">10)</span></span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>!= -1)</span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>!= <span class="string">255)</span></span><br><span class="line">	;(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>s:&lt; <span class="string">sn-maximum-</span><span class="string">hunt-drop-</span><span class="string">distance)</span></span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>&lt; <span class="string">32)</span></span><br><span class="line">	(<span class="string">unit-type-</span><span class="string">count </span><span class="string">villager-hunter </span>== 0)</span><br><span class="line">	(<span class="string">up-timer-</span><span class="string">status </span>7 != <span class="string">timer-running)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">number-hunters </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-hunt-</span><span class="string">group-size </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-lure-</span><span class="string">group-size </span>1)</span><br><span class="line">	;(<span class="string">up-chat-</span><span class="string">data-to-</span><span class="string">self </span><span class="string">"sn-maximum-hunt-drop-distance: %d"</span> s: <span class="string">sn-maximum-</span><span class="string">hunt-drop-</span><span class="string">distance)</span></span><br><span class="line">	(<span class="string">chat-local-</span><span class="string">to-self </span><span class="string">"Begin luring boar"</span>)</span><br><span class="line">	(<span class="string">up-retask-</span><span class="string">gatherers </span><span class="string">food </span>c: 1)</span><br><span class="line">	(<span class="string">up-request-</span><span class="string">hunters </span>c: 1)</span><br><span class="line">	(<span class="string">enable-timer </span>7 5)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>up-retask-gatherers</code>重新指派给定数量的村民收集某种资源。<br><code>up-request-hunters</code>尝试请求给定数量的猎人加入采集猪肉的队伍，不能保证到达给定的全部数量。<br><code>villager-hunter</code>是一个在UserPatch之外的常数，表示猎人的数目。经过测试，牧羊人不能称作猎人。<br>下面两个命令容易混淆，<code>sn-minimum-boar-hunt-group-size</code>指的是达到多少个农民就可以开始猎杀野猪（此时猪可能已经被拉到TC下）。而<code>sn-minimum-boar-lure-group-size</code>指的是使用多少个农民拉猪，由于猪只同时对一个农民仇恨，所以一般设为1<br><code>sn-minimum-number-hunters</code>用来强制至少有多少猎人，一般在杀猪时结合<code>sn-minimum-boar-hunt-group-size</code>和<code>up-request-hunters</code>使用。<br><code>enable-timer 7 5</code>这个是干什么用的呢？这是为了防止之前杀猪的农民挂了，可以重新拉猪<br>拉猪是拉猪，拉到TC下还要杀猪，下面的rule用来处理杀猪。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">strategic-number </span><span class="string">sn-enable-</span><span class="string">boar-hunting </span>== 2)</span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>!= -1)</span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>&lt; 5)</span><br><span class="line">	(<span class="string">or(</span><span class="string">unit-type-</span><span class="string">count </span><span class="string">122 </span>&gt;= 1)</span><br><span class="line">	   (<span class="string">unit-type-</span><span class="string">count </span><span class="string">216 </span>&gt;= 1))</span><br><span class="line">	(<span class="string">unit-type-</span><span class="string">count </span><span class="string">villager-hunter </span>&lt; 6) ; 8</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">number-hunters </span>8)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-hunt-</span><span class="string">group-size </span>8)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-lure-</span><span class="string">group-size </span>8)</span><br><span class="line">	(<span class="string">chat-local-</span><span class="string">to-self </span><span class="string">"Request support hunters"</span>)</span><br><span class="line">	;(<span class="string">up-retask-</span><span class="string">gatherers </span><span class="string">food </span>c: 8)</span><br><span class="line">	(<span class="string">up-request-</span><span class="string">hunters </span>c: 8)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>这里122指男猎人 ，216指女猎人，当猪离TC很近了（小于等于5），这时候就用猎人来杀猪。<br>下面的规则用来拉第二头猪。<br>经测试“Attempting to lure another boar”、“Injured villager found – search again.”、“Begin luring boar (2)”三条规则依次触发。<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">strategic-number </span><span class="string">sn-enable-</span><span class="string">boar-hunting </span>== 2)</span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>s:&lt; <span class="string">sn-maximum-</span><span class="string">hunt-drop-</span><span class="string">distance)</span></span><br><span class="line">	(<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">boar-hunting </span>&lt; <span class="string">10)</span></span><br><span class="line">	(<span class="string">up-remaining-</span><span class="string">boar-amount </span>&lt; <span class="string">195)</span></span><br><span class="line">	(<span class="string">strategic-number </span><span class="string">sn-minimum-</span><span class="string">number-hunters </span>&gt; 1)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">number-hunters </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-hunt-</span><span class="string">group-size </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-lure-</span><span class="string">group-size </span>1)</span><br><span class="line">	(<span class="string">chat-local-</span><span class="string">to-self </span><span class="string">"Attempting to lure another boar"</span>)</span><br><span class="line">	(<span class="string">up-reset-</span><span class="string">search </span>1 1 1 1)</span><br><span class="line">	(<span class="string">up-reset-</span><span class="string">filters)</span></span><br><span class="line">	(<span class="string">up-set-</span><span class="string">target-point </span><span class="string">gl-position-</span><span class="string">self-x)</span></span><br><span class="line">	(<span class="string">up-filter-</span><span class="string">distance </span>c: -1 c: <span class="string">10)</span></span><br><span class="line">	(<span class="string">up-find-</span><span class="string">local </span>c: <span class="string">villager-class </span>c: 1)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">gl-boar-</span><span class="string">lurer-search </span>1)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>up-remaining-boar-amount</code>检查当前猪所剩食物量。只有在另一猪可捕猎时，本数据才有效。否则数据会是65535（似乎65535等于-1，不知道为啥不设为0或者-1），以显示这是最后一头猪。Barbarian野蛮人ai似乎都没有用过这个fact。<br>因为第二头猪通常比较远，而且拉完第一个猪农民会有残血，所以这里检查当前农民的血量是否足够，不够的话会<code>(up-jump-rule -1)</code>回到上面的“Attempting to lure another boar”，重新搜索一个农民。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">goal</span> gl-boar-lurer-search <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-set-target-object</span> search-local c: <span class="number">0</span>)</span><br><span class="line">	(<span class="name">up-object-data</span> object-data-hitpoints &lt; <span class="number">40</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-reset-search</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>)</span><br><span class="line">	(<span class="name">up-find-local</span> c: villager-class c: <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-jump-rule</span> <span class="number">-1</span>)</span><br><span class="line">	(<span class="name">chat-local-to-self</span> <span class="string">"Injured villager found -- search again."</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>up-object-data</code>检查选定目标物件的特定信息，<code>object-data-hitpoints</code>常数表示生命值。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(defrule</span><br><span class="line">	(goal gl-boar-lurer-<span class="built_in">search</span> <span class="number">1</span>)</span><br><span class="line">	(<span class="keyword">up</span>-<span class="keyword">set</span>-target-object <span class="built_in">search</span>-local <span class="keyword">c</span>: <span class="number">0</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="keyword">up</span>-<span class="built_in">filter</span>-distance <span class="keyword">c</span>: -<span class="number">1</span> <span class="variable">s:</span> <span class="keyword">sn</span>-maximum-hunt-<span class="keyword">drop</span>-distance)</span><br><span class="line">	(<span class="keyword">set</span>-strategic-<span class="keyword">number</span> <span class="keyword">sn</span>-focus-player-<span class="keyword">number</span> <span class="number">0</span>)</span><br><span class="line">	(<span class="keyword">up</span>-<span class="keyword">find</span>-remote <span class="keyword">c</span>: wild-boar <span class="keyword">c</span>: <span class="number">1</span>)</span><br><span class="line">	(<span class="keyword">up</span>-<span class="keyword">find</span>-remote <span class="keyword">c</span>: javelina <span class="keyword">c</span>: <span class="number">1</span>)</span><br><span class="line">	(<span class="keyword">up</span>-<span class="keyword">set</span>-target-object <span class="built_in">search</span>-remote <span class="keyword">c</span>: <span class="number">0</span>)</span><br><span class="line">	(<span class="keyword">up</span>-target-objects <span class="number">0</span> action-default -<span class="number">1</span> -<span class="number">1</span>)</span><br><span class="line">	(chat-local-<span class="keyword">to</span>-self <span class="string">"Begin luring boar (2)"</span>)</span><br><span class="line">	(<span class="keyword">set</span>-goal gl-boar-lurer-<span class="built_in">search</span> <span class="number">2</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>sn-maximum-hunt-drop-distance</code>设置电脑玩家捕猎时资源距离资源放置点的最大距离。<br>这里<code>wild-boar</code>和<code>javelina</code>都表示野猪。<br>下面的这个规则就很有意思了，为啥会有这个条件呢？<br>首先触发条件，主要包括3部分：</p>
<ol>
<li><code>(goal gl-boar-lurer-search 2)</code><br> 当”Begin luring boar (2)”对应规则被触发后即满足，也就是说它只发生在拉第二头猪</li>
<li><code>dropsite-min-distance live-boar &lt; 5</code><br> 表示当猪足够近的时候</li>
<li><code>up-timer-status 7 != timer-running</code><br> 这个条件似乎正常情况下并不会满足<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span></span><br><span class="line">	(<span class="name">strategic-number</span> sn-enable-boar-hunting == <span class="number">2</span>)</span><br><span class="line">	(<span class="name">dropsite-min-distance</span> live-boar != <span class="number">-1</span>)</span><br><span class="line">	(<span class="name">dropsite-min-distance</span> live-boar &lt; <span class="number">5</span>)</span><br><span class="line">	(<span class="name">goal</span> gl-boar-lurer-search <span class="number">2</span>)</span><br><span class="line">	(<span class="name">unit-type-count</span> villager-hunter &gt; <span class="number">0</span>)</span><br><span class="line">	(<span class="name">up-timer-status</span> <span class="number">7</span> != timer-running)</span><br><span class="line">	<span class="comment">;(unit-type-count villager-hunter &gt;= 8)</span></span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-reset-search</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-reset-filters</span>)</span><br><span class="line">	(<span class="name">up-set-target-point</span> gl-position-self-x)</span><br><span class="line">	(<span class="name">up-filter-distance</span> c: <span class="number">-1</span> c: <span class="number">10</span>)</span><br><span class="line">	(<span class="name">up-find-local</span> c: villager-class c: <span class="number">6</span>)</span><br><span class="line">	(<span class="name">set-strategic-number</span> sn-focus-player-number <span class="number">0</span>)</span><br><span class="line">	(<span class="name">up-find-remote</span> c: wild-boar c: <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-find-remote</span> c: javelina c: <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-target-objects</span> <span class="number">0</span> action-default <span class="number">-1</span> <span class="number">-1</span>)</span><br><span class="line">	(<span class="name">enable-timer</span> <span class="number">7</span> <span class="number">10</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>我们看看<code>(up-set-target-point gl-position-self-x)</code>，通过检查前面的代码<code>gl-position-self-x</code>指的是TC的坐标。<br>所以说它的作用是当第二只猪很近的时候，隔一段时间选择6个农民走向它，这是在杀猪么？然而同样触发的是“Request support hunters”，并且可能会触发好几次。</p>
<h3 id="赶鹿"><a href="#赶鹿" class="headerlink" title="赶鹿"></a>赶鹿</h3><p>下面这条规则是当没有猪时开始杀鹿<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">defrule</span></span><br><span class="line"><span class="string">	</span>(<span class="string">up-research-</span><span class="string">status </span>c: <span class="string">ri-loom </span>&gt;= <span class="string">research-pending)</span></span><br><span class="line">	(<span class="string">unit-type-</span><span class="string">count-total </span><span class="string">villager </span>&gt;= <span class="string">11)</span></span><br><span class="line">	(<span class="string">strategic-number </span><span class="string">sn-enable-</span><span class="string">boar-hunting </span>== 2)</span><br><span class="line">	(<span class="string">unit-type-</span><span class="string">count-total </span><span class="string">villager </span>&gt;= <span class="string">20)</span></span><br><span class="line">	(<span class="string">up-compare-</span><span class="string">goal </span><span class="string">gl-my-</span><span class="string">boars </span>&lt; 1)</span><br><span class="line">	(<span class="string">or(</span><span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>== -1)</span><br><span class="line">	   (<span class="string">dropsite-min-</span><span class="string">distance </span><span class="string">live-boar </span>s:&gt; <span class="string">sn-maximum-</span><span class="string">hunt-drop-</span><span class="string">distance)</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-enable-</span><span class="string">boar-hunting </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">number-hunters </span>0) ; 4</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-hunt-</span><span class="string">group-size </span>1)</span><br><span class="line">	(<span class="built_in">set-strategic-number</span> <span class="string">sn-minimum-</span><span class="string">boar-lure-</span><span class="string">group-size </span>1)</span><br><span class="line">	(<span class="built_in">set-goal</span> <span class="string">gl-boar-</span><span class="string">lurer-search </span>0)</span><br><span class="line">	;(<span class="string">up-retask-</span><span class="string">gatherers </span><span class="string">food </span>c: 4)</span><br><span class="line">	(<span class="string">up-request-</span><span class="string">hunters </span>c: 4)</span><br><span class="line">	(<span class="string">chat-local-</span><span class="string">to-self </span><span class="string">"No boar in range, allow deer hunting"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h3 id="种田"><a href="#种田" class="headerlink" title="种田"></a>种田</h3><h4 id="空闲的农田"><a href="#空闲的农田" class="headerlink" title="空闲的农田"></a>空闲的农田</h4><p>初期农田会空闲，这是因为农民要去杀猪和杀羊，如果不去杀动物，那么它们的尸体会慢慢腐烂，食物就浪费了，但是田一旦建好了就不会坏，所以可以先杀动物，再种田。<br>当城镇被攻击后农民会空闲。</p>
<h3 id="升级时代"><a href="#升级时代" class="headerlink" title="升级时代"></a>升级时代</h3><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defrule</span>	</span><br><span class="line">	(<span class="name">game-time</span> &gt; <span class="number">132</span>)</span><br><span class="line">	(<span class="name">food-amount</span> &lt; <span class="number">50</span>)</span><br><span class="line">	(<span class="name">up-research-status</span> c: feudal-age &lt; research-pending) <span class="comment">; current-age &lt; imp</span></span><br><span class="line">	(<span class="name">up-pending-objects</span> c: villager &lt; <span class="number">1</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-drop-resources</span> sheep-food c: <span class="number">5</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> farm-food c: <span class="number">5</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> forage-food c: <span class="number">5</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> deer-food c: <span class="number">20</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> boar-food c: <span class="number">7</span>) <span class="comment">; 10</span></span><br><span class="line">)</span><br><span class="line">(<span class="name">defrule</span>	</span><br><span class="line">	(<span class="name">game-time</span> &gt; <span class="number">132</span>)</span><br><span class="line">	(<span class="name">food-amount</span> &lt; <span class="number">50</span>)</span><br><span class="line">	(<span class="name">food-amount</span> &gt;= <span class="number">44</span>)</span><br><span class="line">	(<span class="name">up-research-status</span> c: feudal-age &lt; research-pending) </span><br><span class="line">	(<span class="name">up-pending-objects</span> c: villager &lt; <span class="number">1</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-drop-resources</span> sheep-food c: <span class="number">2</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> farm-food c: <span class="number">2</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> forage-food c: <span class="number">2</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> deer-food c: <span class="number">20</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> boar-food c: <span class="number">2</span>) <span class="comment">; 10</span></span><br><span class="line">)</span><br><span class="line">(<span class="name">defrule</span>	</span><br><span class="line">	(<span class="name">current-age</span> == dark-age)</span><br><span class="line">	(<span class="name">strategic-number</span> sn-enable-training-queue == <span class="number">1</span>)</span><br><span class="line">	(<span class="name">up-pending-objects</span> c: villager &lt; <span class="number">2</span>)</span><br><span class="line">	(<span class="name">food-amount</span> &lt; <span class="number">50</span>)</span><br><span class="line">	(<span class="name">timer-triggered</span> <span class="number">46</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(<span class="name">up-drop-resources</span> sheep-food c: <span class="number">5</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> farm-food c: <span class="number">5</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> forage-food c: <span class="number">5</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> deer-food c: <span class="number">20</span>)</span><br><span class="line">	(<span class="name">up-drop-resources</span> boar-food c: <span class="number">10</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这里<code>up-drop-resources</code>指的是让至少携带若干资源的村民上交资源，例如当初期要断农民或者差一点点封建的时候，就可以使用这个命令争取时间。<br>在黑暗时代农民只能携带10单位的资源，在后面升级了手推车等科技之后农民携带的资源会增多。此外如果让一个携带某种资源的农民去采集另外的资源，那么已采集到的资源会被丢弃，但是如果是去修建筑资源不会被丢弃。也可以通过<code>up-garrison</code>指令让农民进入TC交资源再出来，节省走路时间。</p>
<h3 id="放兵营"><a href="#放兵营" class="headerlink" title="放兵营"></a>放兵营</h3><p>为啥兵营会放在不前不后的地方？</p>
<h3 id="侦察敌情"><a href="#侦察敌情" class="headerlink" title="侦察敌情"></a>侦察敌情</h3><p>一般小马探路只会在家里转，这叫explorer。那么如何让它探对手家里呢？<br><code>up-send-scout</code>加上<code>position-</code>位置常数可以做到这一点</p>
<h3 id="强行建造"><a href="#强行建造" class="headerlink" title="强行建造"></a>强行建造</h3><p>征服者的默认AI建造工事的时候，如果被攻击就会立刻取消建筑，事实上这是不完善的，比如有时候我们就想强行肛一个城堡。<code>sn-percent-building-cancellation</code>可以提供这样的功能</p>
<h3 id="建造第二个TC"><a href="#建造第二个TC" class="headerlink" title="建造第二个TC"></a>建造第二个TC</h3><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(defrule</span><br><span class="line">	(building-<span class="built_in">type</span>-<span class="built_in">count</span>-total town-center &gt;= <span class="number">1</span>)</span><br><span class="line">	(building-<span class="built_in">type</span>-<span class="built_in">count</span>-total town-center &lt; <span class="number">2</span>)</span><br><span class="line">=&gt;</span><br><span class="line">	(set-strategic-number sn-town-center-placement mining-camp)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div></div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/img/fkm/wxfk.jpg" alt="Calvin Neo WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/img/fkm/zfbfk.jpg" alt="Calvin Neo Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/游戏/" rel="tag"># 游戏</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/02/苏州无锡连云港游记/" rel="next" title="苏州无锡连云港游记">
                <i class="fa fa-chevron-left"></i> 苏州无锡连云港游记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/11/数理统计复习/" rel="prev" title="数理统计复习">
                数理统计复习 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/favicon.jpg"
               alt="Calvin Neo" />
          <p class="site-author-name" itemprop="name">Calvin Neo</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">113</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">128</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CalvinNeo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/CalvinNeo0" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1568200035" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://xqq.im/" title="xqq" target="_blank">xqq</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.lovelywen.com/" title="wenwen" target="_blank">wenwen</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://smlight.github.io/blog/" title="zyyyyy" target="_blank">zyyyyy</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Native-DSL简介"><span class="nav-number">1.</span> <span class="nav-text">Native DSL简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#def语法"><span class="nav-number">1.1.</span> <span class="nav-text">def语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load语法"><span class="nav-number">1.2.</span> <span class="nav-text">load语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#随机加载"><span class="nav-number">1.2.1.</span> <span class="nav-text">随机加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#条件加载"><span class="nav-number">1.2.2.</span> <span class="nav-text">条件加载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通配符（wildcard）"><span class="nav-number">1.3.</span> <span class="nav-text">通配符（wildcard）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#facts、actions、parameters、variables和goal"><span class="nav-number">1.4.</span> <span class="nav-text">facts、actions、parameters、variables和goal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定时器"><span class="nav-number">1.5.</span> <span class="nav-text">定时器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关系运算符"><span class="nav-number">1.6.</span> <span class="nav-text">关系运算符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#策略"><span class="nav-number">1.7.</span> <span class="nav-text">策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#escrow预留资源"><span class="nav-number">1.8.</span> <span class="nav-text">escrow预留资源</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AI基本操作"><span class="nav-number">2.</span> <span class="nav-text">AI基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#调试"><span class="nav-number">2.1.</span> <span class="nav-text">调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用taunt调试"><span class="nav-number">2.1.1.</span> <span class="nav-text">使用taunt调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补人口"><span class="nav-number">2.2.</span> <span class="nav-text">补人口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#城镇规模-TSA-进攻"><span class="nav-number">2.3.</span> <span class="nav-text">城镇规模(TSA)进攻</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修建围墙"><span class="nav-number">2.4.</span> <span class="nav-text">修建围墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小围技术"><span class="nav-number">2.5.</span> <span class="nav-text">小围技术</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Native-AI赏析之BOOM-II"><span class="nav-number">3.</span> <span class="nav-text">Native AI赏析之BOOM II</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#防守塔爆"><span class="nav-number">3.1.</span> <span class="nav-text">防守塔爆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#塔爆状态流"><span class="nav-number">3.1.1.</span> <span class="nav-text">塔爆状态流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防守TC暴"><span class="nav-number">3.1.2.</span> <span class="nav-text">防守TC暴</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#城快进攻"><span class="nav-number">3.2.</span> <span class="nav-text">城快进攻</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UserPatch-v1-4简介"><span class="nav-number">4.</span> <span class="nav-text">UserPatch v1.4简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#UP的安装"><span class="nav-number">4.1.</span> <span class="nav-text">UP的安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UP基础语法"><span class="nav-number">4.2.</span> <span class="nav-text">UP基础语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#变量"><span class="nav-number">4.2.1.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get系列函数"><span class="nav-number">4.2.2.</span> <span class="nav-text">get系列函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#get-fact系列"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">get fact系列</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成本函数"><span class="nav-number">4.2.3.</span> <span class="nav-text">成本函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#坐标代数"><span class="nav-number">4.3.</span> <span class="nav-text">坐标代数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流程控制"><span class="nav-number">4.4.</span> <span class="nav-text">流程控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#直接寻的系统"><span class="nav-number">4.5.</span> <span class="nav-text">直接寻的系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#find"><span class="nav-number">4.5.1.</span> <span class="nav-text">find</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#过滤器"><span class="nav-number">4.5.2.</span> <span class="nav-text">过滤器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#人员控制"><span class="nav-number">4.6.</span> <span class="nav-text">人员控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UserPatch-AI赏析之Bruteforce"><span class="nav-number">5.</span> <span class="nav-text">UserPatch AI赏析之Bruteforce</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AI概览"><span class="nav-number">5.1.</span> <span class="nav-text">AI概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开局"><span class="nav-number">5.2.</span> <span class="nav-text">开局</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#造房子"><span class="nav-number">5.2.1.</span> <span class="nav-text">造房子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#农民调配"><span class="nav-number">5.2.2.</span> <span class="nav-text">农民调配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sn设置"><span class="nav-number">5.2.3.</span> <span class="nav-text">sn设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#牵羊"><span class="nav-number">5.2.4.</span> <span class="nav-text">牵羊</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#放伐木场、磨坊"><span class="nav-number">5.2.5.</span> <span class="nav-text">放伐木场、磨坊</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拉猪"><span class="nav-number">5.2.6.</span> <span class="nav-text">拉猪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#赶鹿"><span class="nav-number">5.2.7.</span> <span class="nav-text">赶鹿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#种田"><span class="nav-number">5.2.8.</span> <span class="nav-text">种田</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#空闲的农田"><span class="nav-number">5.2.8.1.</span> <span class="nav-text">空闲的农田</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#升级时代"><span class="nav-number">5.2.9.</span> <span class="nav-text">升级时代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#放兵营"><span class="nav-number">5.2.10.</span> <span class="nav-text">放兵营</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#侦察敌情"><span class="nav-number">5.2.11.</span> <span class="nav-text">侦察敌情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#强行建造"><span class="nav-number">5.2.12.</span> <span class="nav-text">强行建造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建造第二个TC"><span class="nav-number">5.2.13.</span> <span class="nav-text">建造第二个TC</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Calvin Neo</span>
  <span> &nbsp; Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></span>
</div>
<div>
  <span><a href="/about/yytl/">版权声明</a></span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse 
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://calvinneo.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.calvinneo.com/2017/10/03/帝国时代AI开发/';
          this.page.identifier = '2017/10/03/帝国时代AI开发/';
          this.page.title = '帝国时代AI开发';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://calvinneo.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      $('#local-search-input').focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

</body>
</html>
