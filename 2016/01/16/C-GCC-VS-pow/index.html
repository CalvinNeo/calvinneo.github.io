<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="C++,VS,GCC," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="本文通过一个例子试图探讨两个编译器的浮点数运算实现机制以及类型转换的机制。">
<meta property="og:type" content="article">
<meta property="og:title" content="GCC和VS在pow函数实现和类型转换上异同点的辨析">
<meta property="og:url" content="http://www.calvinneo.com/2016/01/16/C-GCC-VS-pow/index.html">
<meta property="og:site_name" content="Calvin's Marbles">
<meta property="og:description" content="本文通过一个例子试图探讨两个编译器的浮点数运算实现机制以及类型转换的机制。">
<meta property="og:image" content="http://www.calvinneo.com/img/gccvspow_gcc1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/gccvspow_vs1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/gccvspow_gcc2.png">
<meta property="og:image" content="http://www.calvinneo.com/img/gccvspow_2gcc1.png">
<meta property="og:image" content="http://www.calvinneo.com/img/gccvspow_2vs1.png">
<meta property="og:updated_time" content="2016-08-29T16:12:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GCC和VS在pow函数实现和类型转换上异同点的辨析">
<meta name="twitter:description" content="本文通过一个例子试图探讨两个编译器的浮点数运算实现机制以及类型转换的机制。">
<meta name="twitter:image" content="http://www.calvinneo.com/img/gccvspow_gcc1.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> GCC和VS在pow函数实现和类型转换上异同点的辨析 | Calvin's Marbles </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Calvin's Marbles</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'MkjHwDHvfrnZTts-XVTB','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                GCC和VS在pow函数实现和类型转换上异同点的辨析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-16T19:20:33+08:00" content="2016-01-16">
              2016-01-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/16/C-GCC-VS-pow/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/16/C-GCC-VS-pow/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文通过一个例子试图探讨两个编译器的浮点数运算实现机制以及类型转换的机制。</p>
<a id="more"></a>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>江科大的nomasp同学在刷Leetcode(171:Excel Colmun Number)的时候发现了一个问题。他的代码（简化后）如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">solve</span><span class="params">(<span class="built_in">string</span> s)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = <span class="number">0</span>, len = s.length();</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; ++ i) &#123;</div><div class="line">        <span class="keyword">int</span> c = s[i] - <span class="string">'A'</span> + <span class="number">1</span>;</div><div class="line">        n += c * <span class="built_in">pow</span>(<span class="number">26</span>, len - <span class="number">1</span> - i);</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"c = "</span> &lt;&lt; c &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"pow = "</span> &lt;&lt; <span class="built_in">pow</span>(<span class="number">26</span>, len - <span class="number">1</span> - i) &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"n = "</span> &lt;&lt; n &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> n;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">cout</span>&lt;&lt;solve(<span class="string">"AAB"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用GCC/G++(4.7.2)编译(g++.exe cpp_path -o exepath -std=c++11 -g3  -static-libstdc++ -static-libgcc -g3)后，输出如下：<br><img src="/img/gccvspow_gcc1.png" alt=""><br>使用VS2015编译后，输出如下：<br><img src="/img/gccvspow_vs1.png" alt=""><br>稍有常识的人都会看出，GCC的结果是错误的。</p>
<h1 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h1><p>有同学认为pow函数是个浮点函数，因此应当转成int之后再相加减，但实际试验之后发现这个问题仍然存在，结果是：<br><img src="/img/gccvspow_gcc2.png" alt=""><br>经过分析，如果手动实现pow函数则GCC的结果是对的。因此定位到调用pow函数这边出了问题。因此取一下测试代码分析。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">float</span> f = <span class="built_in">pow</span>(<span class="number">26</span>, <span class="number">2</span>);</div><div class="line">	<span class="keyword">int</span> i = f;</div><div class="line">	<span class="keyword">int</span> i2 = <span class="built_in">pow</span>(<span class="number">26</span>, <span class="number">2</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%f %d %d\n"</span>, f, i, i2); <span class="comment">//似乎这个版本的GCC不支持%lf</span></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在GCC下编译运行得：<br><img src="/img/gccvspow_2gcc1.png" alt=""><br>在VS下编译运行得：<br><img src="/img/gccvspow_2vs1.png" alt=""><br>可以发现GCC在两次赋值操作的时候是没有问题的，但是在初始化操作的时候，莫名其妙减了1。<br>谦谦同学提出pow函数返回的是double，在转成int的时候需要先转成float再转成int。在他的提示下，我把pow函数改成powf函数，发现返回值正常了。（谦谦同学一并指出在GCC520版本下源代码也能正常运行，所以还是要尽可能及时更新编译器。）</p>
<p>下面，我们分别比较对pow函数的实现以及类型转换机制。</p>
<h2 id="VS对pow的实现"><a href="#VS对pow的实现" class="headerlink" title="VS对pow的实现"></a>VS对pow的实现</h2><p>VS中我们实际上使用的是<br><code>double pow&lt;int, int&gt;(int _Left, int _Right);</code> 这个重载版本。<br>首先定位到头文件<code>xtgmath.h</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//xtgmath.h</span></div><div class="line"><span class="number">_</span>C_STD_BEGIN</div><div class="line"><span class="comment">// #define _STD ::std::</span></div><div class="line"><span class="comment">// #define _CSTD ::</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="number">_</span>Ty1, <span class="keyword">class</span> <span class="number">_</span>Ty2&gt; <span class="keyword">inline</span></div><div class="line">	<span class="keyword">typename</span> <span class="number">_</span>STD enable_if&lt; <span class="number">_</span>STD is_arithmetic&lt;<span class="number">_</span>Ty1&gt;::value &amp;&amp; <span class="number">_</span>STD is_arithmetic&lt;<span class="number">_</span>Ty2&gt;::value		</div><div class="line">	,<span class="keyword">typename</span> <span class="number">_</span>STD <span class="number">_</span>Common_float_type&lt;<span class="number">_</span>Ty1, <span class="number">_</span>Ty2&gt;::type&gt;::<span class="function">type</span></div><div class="line">	<span class="title">pow</span><span class="params">(<span class="keyword">const</span> <span class="number">_</span>Ty1 <span class="number">_L</span>eft, <span class="keyword">const</span> <span class="number">_</span>Ty2 <span class="number">_</span>Right)</span></div><div class="line">	&#123;	<span class="comment">// bring mixed types to a common type</span></div><div class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="number">_</span>STD <span class="number">_</span>Common_float_type&lt;<span class="number">_</span>Ty1, <span class="number">_</span>Ty2&gt;::type type;</div><div class="line">	<span class="keyword">return</span> (<span class="number">_</span>CSTD <span class="built_in">pow</span>(type(<span class="number">_L</span>eft), type(<span class="number">_</span>Right)));</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到最后调用一个参数是<code>_Common_float_type</code>的pow函数，那这个函数在哪里呢，我们首先来看一下<code>_Common_float_type</code>这个类型。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//xtr1common.h	</span></div><div class="line"><span class="keyword">typedef</span> integral_constant&lt;<span class="keyword">bool</span>, <span class="literal">false</span>&gt; false_type;</div><div class="line"><span class="comment">// integral_constant is convenient template for integral constant types</span></div><div class="line"></div><div class="line"><span class="comment">//xtgmath.h	</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="number">_</span>Ty&gt;</div><div class="line">	<span class="keyword">struct</span> <span class="number">_</span>Promote_to_float</div><div class="line">	&#123;	<span class="comment">// promote integral to double</span></div><div class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> conditional&lt;is_integral&lt;<span class="number">_</span>Ty&gt;::value,</div><div class="line">		<span class="keyword">double</span>, <span class="number">_</span>Ty&gt;::type type;</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="number">_</span>Ty1, <span class="keyword">class</span> <span class="number">_</span>Ty2&gt;</div><div class="line">	<span class="keyword">struct</span> <span class="number">_</span>Common_float_type</div><div class="line">	&#123;	<span class="comment">// find type for two-argument math function</span></div><div class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="number">_</span>Promote_to_float&lt;<span class="number">_</span>Ty1&gt;::type <span class="number">_</span>Ty1f;</div><div class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="number">_</span>Promote_to_float&lt;<span class="number">_</span>Ty2&gt;::type <span class="number">_</span>Ty2f;</div><div class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> conditional&lt;is_same&lt;<span class="number">_</span>Ty1f, <span class="keyword">long</span> <span class="keyword">double</span>&gt;::value || is_same&lt;<span class="number">_</span>Ty2f, <span class="keyword">long</span> <span class="keyword">double</span>&gt;::value, <span class="keyword">long</span> <span class="keyword">double</span>,</div><div class="line">		<span class="keyword">typename</span> conditional&lt;is_same&lt;<span class="number">_</span>Ty1f, <span class="keyword">double</span>&gt;::value || is_same&lt;<span class="number">_</span>Ty2f, <span class="keyword">double</span>&gt;::value, <span class="keyword">double</span>,</div><div class="line">			<span class="keyword">float</span>&gt;::type&gt;::type type;</div><div class="line">	&#125;;</div></pre></td></tr></table></figure></p>
<p>这边说明一下这段代码：<br><code>std::conditional</code>有三个参数，其作用相当于_Test? _Ty1: _Ty2，其中_Ty1和_Ty2都是类型，而<code>std::enable_if</code>省略了假的情况。<code>std::is_same</code>用来判断_Ty1和_Ty2是否相同类型。这个是模板编程里面常用到的元函数。<br><code>_Promote_to_float</code>用来将integral类型扩成double类型。<br><code>_Common_float_type</code>意思就是<br><figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (_Ty1 <span class="keyword">is</span> <span class="built_in">long</span> <span class="built_in">double</span> || _Ty2 <span class="keyword">is</span> <span class="built_in">long</span> <span class="built_in">double</span>)</div><div class="line">	define type <span class="built_in">long</span> <span class="built_in">double</span></div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span>(_Ty1 <span class="keyword">is</span> <span class="built_in">double</span> || _Ty2 <span class="keyword">is</span> <span class="built_in">double</span>)</div><div class="line">	define type <span class="built_in">double</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	define type <span class="built_in">float</span></div></pre></td></tr></table></figure></p>
<p>下面我们开启调试，跟踪pow函数执行。在调试中，在断点<code>_CSTD pow(type(_Left), type(_Right))</code>处发现type(_Left)和type(_Right)都已经通过<code>_Common_float_type</code>变成了浮点类型，继续跟踪发现直接调用了math.h中的pow。<br>特别地，对于c mode，<code>pow</code>实际直接调用了<code>pow(double, double)</code>;。<br>此外还注意到<code>&lt;cmath&gt;</code>中有一个的<code>_Check_return_ inline double pow(_In_ double _Xx, _In_ int _Yx)</code>函数，而这个函数实际上调用了<code>&lt;cmath&gt;</code>中的<code>_Pow_int</code>函数，该函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="number">_</span>Ty&gt;</div><div class="line">	<span class="number">_</span>Check_return_ <span class="keyword">inline</span> <span class="number">_</span>Ty <span class="number">_</span>Pow_int(<span class="number">_</span>Ty <span class="number">_</span>Xx, <span class="keyword">int</span> <span class="number">_</span>Yx) <span class="number">_</span>NOEXCEPT</div><div class="line">	&#123;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="number">_</span>Nx;</div><div class="line">	<span class="keyword">if</span> (<span class="number">_</span>Yx &gt;= <span class="number">0</span>)</div><div class="line">		<span class="number">_</span>Nx = <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="number">_</span>Yx);</div><div class="line">	<span class="keyword">else</span></div><div class="line">		<span class="number">_</span>Nx = <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="number">-_</span>Yx);</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="number">_</span>Ty <span class="number">_</span>Zx = <span class="keyword">static_cast</span>&lt;<span class="number">_</span>Ty&gt;(<span class="number">1</span>); ; <span class="number">_</span>Xx *= <span class="number">_</span>Xx)</div><div class="line">		&#123;</div><div class="line">		<span class="keyword">if</span> ((<span class="number">_</span>Nx &amp; <span class="number">1</span>) != <span class="number">0</span>)</div><div class="line">			<span class="number">_</span>Zx *= <span class="number">_</span>Xx;</div><div class="line">		<span class="keyword">if</span> ((<span class="number">_</span>Nx &gt;&gt;= <span class="number">1</span>) == <span class="number">0</span>)</div><div class="line">			<span class="keyword">return</span> (<span class="number">_</span>Yx &lt; <span class="number">0</span> ? <span class="keyword">static_cast</span>&lt;<span class="number">_</span>Ty&gt;(<span class="number">1</span>) / <span class="number">_</span>Zx : <span class="number">_</span>Zx);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这段代码主要就是处理指数为int的情况，其使用的是类似于快速幂的方法得到的结果。不过经过测试，这段代码始终没有被调用的情况，为什么标准库不使用这个重载版本，我想附录里面的一段答案应该能够给我们启发。<br>对于以上代码，我想最重要的就是<code>_Common_float_type</code>，它避免了GCC472版本的类型二次转换的错误，直接调用对应类型的重载版本。</p>
<h2 id="VS对类型转换的实现"><a href="#VS对类型转换的实现" class="headerlink" title="VS对类型转换的实现"></a>VS对类型转换的实现</h2><p>1.double -&gt; int<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;	int i = pow(26, 2);</span></div><div class="line">00E7277E  <span class="keyword">push</span>        <span class="number">2</span>  </div><div class="line">00E72780  <span class="keyword">push</span>        <span class="number">1Ah</span>  </div><div class="line">00E72782  <span class="keyword">call</span>        pow&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; (<span class="number">0E71064h</span>)  </div><div class="line">00E72787  <span class="keyword">add</span>         <span class="built_in">esp</span>,<span class="number">8</span>  </div><div class="line">00E7278A  <span class="keyword">call</span>        __ftol2_sse (<span class="number">0E71195h</span>)  </div><div class="line">00E7278F  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [i],<span class="built_in">eax</span>  </div><div class="line"><span class="comment">;	int i = pow(26.0, 2.0);</span></div><div class="line">00FE277E  <span class="keyword">sub</span>         <span class="built_in">esp</span>,<span class="number">8</span>  </div><div class="line">00FE2781  <span class="keyword">movsd</span>       <span class="built_in">xmm0</span>,mmword <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0FEAB98h</span>]  </div><div class="line">00FE2789  <span class="keyword">movsd</span>       mmword <span class="built_in">ptr</span> [<span class="built_in">esp</span>],<span class="built_in">xmm0</span>  </div><div class="line">00FE278E  <span class="keyword">sub</span>         <span class="built_in">esp</span>,<span class="number">8</span>  </div><div class="line">00FE2791  <span class="keyword">movsd</span>       <span class="built_in">xmm0</span>,mmword <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0FEABD0h</span>]  </div><div class="line">00FE2799  <span class="keyword">movsd</span>       mmword <span class="built_in">ptr</span> [<span class="built_in">esp</span>],<span class="built_in">xmm0</span>  </div><div class="line">00FE279E  <span class="keyword">call</span>        _pow (<span class="number">0FE11FEh</span>)  </div><div class="line">00FE27A3  <span class="keyword">add</span>         <span class="built_in">esp</span>,<span class="number">10h</span>  </div><div class="line">00FE27A6  <span class="keyword">call</span>        __ftol2_sse (<span class="number">0FE1195h</span>)  </div><div class="line">00FE27AB  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [i],<span class="built_in">eax</span>  </div><div class="line"><span class="comment">;	double s = 26.0;</span></div><div class="line">00D8277E  <span class="keyword">movsd</span>       <span class="built_in">xmm0</span>,mmword <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0D8AB98h</span>]  </div><div class="line">00D82786  <span class="keyword">movsd</span>       mmword <span class="built_in">ptr</span> [s],<span class="built_in">xmm0</span>  </div><div class="line"><span class="comment">;	int i = s;</span></div><div class="line">00D8278B  <span class="keyword">cvttsd2si</span>   <span class="built_in">eax</span>,mmword <span class="built_in">ptr</span> [s]  </div><div class="line">00D82790  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [i],<span class="built_in">eax</span></div></pre></td></tr></table></figure></p>
<p>这里我们发现如果pow参数都为int则是调用pow<int, int="">，而这个pow<int, int="">是通过xtgmath.h中的pow函数实现的：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">_C_STD_BEGIN</div><div class="line"><span class="comment">;template&lt;class _Ty1,</span></div><div class="line"><span class="comment">;	class _Ty2&gt; inline</span></div><div class="line"><span class="comment">;	typename _STD enable_if&lt; _STD is_arithmetic&lt;_Ty1&gt;::value</span></div><div class="line"><span class="comment">;		&amp;&amp; _STD is_arithmetic&lt;_Ty2&gt;::value,</span></div><div class="line"><span class="comment">;		typename _STD _Common_float_type&lt;_Ty1, _Ty2&gt;::type&gt;::type</span></div><div class="line"><span class="comment">;	pow(const _Ty1 _Left, const _Ty2 _Right)</span></div><div class="line"><span class="comment">;	&#123;	// bring mixed types to a common type</span></div><div class="line">00FE2B12  <span class="keyword">mov</span>         <span class="built_in">ecx</span>,<span class="number">30h</span>  </div><div class="line">00FE2B17  <span class="keyword">mov</span>         <span class="built_in">eax</span>,<span class="number">0CCCCCCCCh</span>  </div><div class="line">00FE2B1C  <span class="keyword">rep</span> stos    <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>]  </div><div class="line"><span class="comment">;	typedef typename _STD _Common_float_type&lt;_Ty1, _Ty2&gt;::type type;</span></div><div class="line"><span class="comment">;	return (_CSTD pow(type(_Left), type(_Right)));</span></div><div class="line">00FE2B1E  <span class="keyword">cvtsi2sd</span>    <span class="built_in">xmm0</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [_Right]  </div><div class="line">00FE2B23  <span class="keyword">sub</span>         <span class="built_in">esp</span>,<span class="number">8</span>  </div><div class="line">00FE2B26  <span class="keyword">movsd</span>       mmword <span class="built_in">ptr</span> [<span class="built_in">esp</span>],<span class="built_in">xmm0</span>  </div><div class="line">00FE2B2B  <span class="keyword">cvtsi2sd</span>    <span class="built_in">xmm0</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [_Left]  </div><div class="line">00FE2B30  <span class="keyword">sub</span>         <span class="built_in">esp</span>,<span class="number">8</span>  </div><div class="line">00FE2B33  <span class="keyword">movsd</span>       mmword <span class="built_in">ptr</span> [<span class="built_in">esp</span>],<span class="built_in">xmm0</span>  </div><div class="line">00FE2B38  <span class="keyword">call</span>        _pow (<span class="number">0FE11FEh</span>)  </div><div class="line">00FE2B3D  <span class="keyword">add</span>         <span class="built_in">esp</span>,<span class="number">10h</span>  </div><div class="line"><span class="comment">;	&#125;</span></div></pre></td></tr></table></figure></int,></int,></p>
<p><code>cvtsi2sd</code>来自SSE2，负责取出最低位的64位整型，并将其转换为一个浮点值，存放到xmm0浮点寄存器中。<br><code>mmword</code>负责将xmm0内的浮点移到[esp]<br>所以pow<int, int="">实现也是先转换成浮点再调用<code>_pow</code><br>对于<code>__ftol2_sse</code>函数底层是调用<code>cvtsi2sd</code>函数的，相比之下由于double是有符号而且表示范围要大于int，因此需要额外加一些处理。所以实际上通过调用<code>cvttsd2si</code>函数进行了类型转换。</int,></p>
<p>2.float -&gt; int<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;	int i = powf(26, 2);</span></div><div class="line">00C5277E  <span class="keyword">push</span>        <span class="built_in">ecx</span>  </div><div class="line">00C5277F  <span class="keyword">movss</span>       <span class="built_in">xmm0</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0C5AB48h</span>]  </div><div class="line">00C52787  <span class="keyword">movss</span>       <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>],<span class="built_in">xmm0</span>  </div><div class="line">00C5278C  <span class="keyword">push</span>        <span class="built_in">ecx</span>  </div><div class="line">00C5278D  <span class="keyword">movss</span>       <span class="built_in">xmm0</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0C5AB4Ch</span>]  </div><div class="line">00C52795  <span class="keyword">movss</span>       <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>],<span class="built_in">xmm0</span>  </div><div class="line">00C5279A  <span class="keyword">call</span>        _powf (<span class="number">0C51523h</span>)  </div><div class="line">00C5279F  <span class="keyword">add</span>         <span class="built_in">esp</span>,<span class="number">8</span>  </div><div class="line">00C527A2  <span class="keyword">call</span>        __ftol2_sse (<span class="number">0C51195h</span>)  </div><div class="line">00C527A7  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [i],<span class="built_in">eax</span>  </div><div class="line"><span class="comment">;	float s = 26.0;</span></div><div class="line">00D5277E  <span class="keyword">movss</span>       <span class="built_in">xmm0</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0D5AB48h</span>]  </div><div class="line">00D52786  <span class="keyword">movss</span>       <span class="built_in">dword</span> <span class="built_in">ptr</span> [s],<span class="built_in">xmm0</span>  </div><div class="line"><span class="comment">;	int i = s;</span></div><div class="line">00D5278B  <span class="keyword">cvttss2si</span>   <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [s]  </div><div class="line">00D52790  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [i],<span class="built_in">eax</span></div></pre></td></tr></table></figure></p>
<h2 id="GCC对pow的实现"><a href="#GCC对pow的实现" class="headerlink" title="GCC对pow的实现"></a>GCC对pow的实现</h2><p>GCC版本之间差别比较大，我们这里还以472分析。</p>
<h1 id="Postscript"><a href="#Postscript" class="headerlink" title="Postscript"></a>Postscript</h1><p>本文参考了在 <a href="http://www.cplusplus.com/forum/general/5207/" target="_blank" rel="external">cplusplus.com</a> 上guestgulkan给出的这样的解答：</p>
<blockquote>
<p>This is actually quite interesting and works differently on Microsoft Visual Studio 2008 and Dev C++(using mingw);</p>
<ol>
<li>Microsoft Visual Studio 2008 cmath is basically a wrapper that calls math.h.<br>In math.h if running in C mode you only get one power function pow(double, double).<br>In C++ mode (which we are using) you get the c++ overloaded functions:<br>long double pow(long double,int), float pow(float,int), double pow(double,int) and a few others.<br>So calling pow(int, int) for example pow(3,2) will always fail due to ambiguity whether you include cmath or math.h</li>
<li>DEV C++ with MINGW<br>With this set up, math.h just contains the the usual C function<br>pow(double, double) - so all the functions work because with pow(int, int) both ints get promoted to double by compiler and all is OK<br>cmath in more than a wrapper for math.h. First it includes math.h and then undefines a whole lot of stuff that math.h defined, and substitutes the c++ versions.<br>This includes the pow function declaration.<br>As the c++ overloaded functions (same as any other c++ compiler), you will get the ambiguity problem - when using pow(int, int).<br>P.S The ambiguity occurs with pow(int, int) because integers can be promoted to floats or doubles, which means that pow(int, int) can fit any of the 6 or so overloaded c++ pow function - so the compiler gets confused. </li>
</ol>
</blockquote>
<p>对于标准库对pow函数的处理，<a href="http://stackoverflow.com/questions/2398442/why-isnt-int-powint-base-int-exponent-in-the-standard-c-libraries?answertab=active#tab-top" target="_blank" rel="external">stackoverflow</a>上的enigmaticPhysicist给出了这样的回答：</p>
<blockquote>
<p>A specialisation of pow(x, n) to where n is a natural number is often useful for time performance. But the standard library’s generic pow() still works pretty (surprisingly!) well for this purpose and it is absolutely critical to include as little as possible in the standard C library so it can be made as portable and as easy to implement as possible. On the other hand, that doesn’t stop it at all from being in the C++ standard library or the STL, which I’m pretty sure nobody is planning on using in some kind of embedded platform.</p>
</blockquote>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/C/" rel="tag">#C++</a>
          
            <a href="/tags/VS/" rel="tag">#VS</a>
          
            <a href="/tags/GCC/" rel="tag">#GCC</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/26/brainfuck/" rel="next" title="brainfuck">
                <i class="fa fa-chevron-left"></i> brainfuck
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/03/06/numpy/" rel="prev" title="numpy的套路">
                numpy的套路 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/01/16/C-GCC-VS-pow/"
           data-title="GCC和VS在pow函数实现和类型转换上异同点的辨析" data-url="http://www.calvinneo.com/2016/01/16/C-GCC-VS-pow/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/favicon.jpg"
               alt="Calvin Neo" />
          <p class="site-author-name" itemprop="name">Calvin Neo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">28</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CalvinNeo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/CalvinNeo0" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1568200035" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#问题描述"><span class="nav-number">1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#问题分析"><span class="nav-number">2.</span> <span class="nav-text">问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#VS对pow的实现"><span class="nav-number">2.1.</span> <span class="nav-text">VS对pow的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VS对类型转换的实现"><span class="nav-number">2.2.</span> <span class="nav-text">VS对类型转换的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GCC对pow的实现"><span class="nav-number">2.3.</span> <span class="nav-text">GCC对pow的实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Postscript"><span class="nav-number">3.</span> <span class="nav-text">Postscript</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Calvin Neo</span>
</div>

<p>
<span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
<span id="busuanzi_container_site_uv"> | 总访客数<span id="busuanzi_value_site_uv"></span>次</span>
<span id="busuanzi_container_site_uv"> | 本文阅读量<span id="busuanzi_value_page_pv"></span>次</span>
</p>
  
<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"calvinneoorg"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
